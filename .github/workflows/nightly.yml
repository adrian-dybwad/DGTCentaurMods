# Build nightly release from main branch
name: Nightly

on:
  push:
    branches: [main, UniversalChess]
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build Nightly
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/universalchess/web-app/package-lock.json
      
      - name: Generate nightly version
        id: version
        run: |
          BASE_VERSION=$(grep -E "^Version:" packaging/deb-root/DEBIAN/control | cut -d' ' -f2)
          DATE_TAG=$(date +%Y-%m-%d)
          NIGHTLY_VERSION="${BASE_VERSION}-nightly.$(date +%Y%m%d).${GITHUB_SHA::7}"
          echo "version=$NIGHTLY_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "date_tag=$DATE_TAG" >> $GITHUB_OUTPUT
          echo "tag_name=nightly-${DATE_TAG}" >> $GITHUB_OUTPUT
          
          # Update control file with nightly version
          sed -i "s/^Version: .*/Version: ${NIGHTLY_VERSION}/" packaging/deb-root/DEBIAN/control
          echo "Building nightly version: $NIGHTLY_VERSION"
      
      - name: Build .deb package
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh
      
      - name: Generate checksums
        run: |
          cd scripts/releases
          sha256sum *.deb > SHA256SUMS.txt
      
      - name: Create dated nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: "Nightly Build - ${{ steps.version.outputs.date_tag }}"
          prerelease: true
          files: |
            scripts/releases/*.deb
            scripts/releases/SHA256SUMS.txt
          body: |
            ## Nightly Build - ${{ steps.version.outputs.date_tag }}
            
            **This is an automated build from the latest development branch.**
            **Not recommended for production use.**
            
            - Base version: ${{ steps.version.outputs.base_version }}
            - Build version: ${{ steps.version.outputs.version }}
            - Commit: ${{ github.sha }}
            - Built: ${{ github.event.head_commit.timestamp }}
            
            ## Installation
            
            Download and install on your Raspberry Pi:
            
            ```bash
            # Download the .deb file (run on the Pi)
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/universal-chess_${{ steps.version.outputs.version }}_all.deb
            
            # Install
            sudo dpkg -i universal-chess_${{ steps.version.outputs.version }}_all.deb
            sudo apt-get install -f  # Install any missing dependencies
            ```
            
            Or download the `.deb` file from the Assets section below and transfer it to your Pi.
            
            ## Switch to Stable
            
            To switch back to stable releases:
            ```bash
            sudo apt-get install --reinstall universal-chess
            ```
      
      - name: Delete old nightly releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 7
          delete_tag_pattern: nightly-
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

