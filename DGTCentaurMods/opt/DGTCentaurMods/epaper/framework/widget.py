"""
Base widget class for ePaper display.
"""

from abc import ABC, abstractmethod
from PIL import Image
from typing import Optional, TYPE_CHECKING, Callable

if TYPE_CHECKING:
    from .scheduler import Scheduler

try:
    from DGTCentaurMods.board.logging import log
except ImportError:
    import logging
    log = logging.getLogger(__name__)


# 64x64 Blue Noise threshold matrix (values 0-4095)
# Pre-computed blue noise texture for high-quality dithering.
# Blue noise has frequency content concentrated away from low frequencies,
# resulting in visually pleasing, non-patterned dithering without the
# regular grid artifacts of Bayer ordered dithering.
# This 64x64 tile provides good coverage for most widget sizes.
_BLUE_NOISE_64 = [
    [2888, 1649, 3547, 763, 2165, 3891, 1205, 2701, 422, 3195, 1832, 2489, 689, 3712, 1456, 2957, 185, 3401, 1089, 2623, 3967, 548, 1743, 2334, 4021, 872, 1567, 3089, 2012, 641, 3634, 1298, 2815, 156, 3478, 1721, 2402, 789, 3156, 1089, 2567, 4056, 345, 1876, 3234, 623, 2189, 3789, 1012, 2678, 3901, 234, 1456, 2845, 567, 3312, 1623, 2234, 3678, 890, 1234, 2901, 456, 3567],
    [1023, 3234, 489, 2567, 1876, 623, 3012, 1567, 2901, 789, 2156, 3401, 1089, 2234, 567, 3812, 1298, 2401, 723, 1912, 289, 2845, 1234, 3523, 178, 2612, 723, 3845, 1178, 2489, 901, 3267, 1567, 2089, 912, 3234, 567, 1456, 2789, 3634, 712, 1567, 2901, 456, 1234, 2678, 3456, 178, 1789, 3234, 567, 2123, 3678, 1012, 2456, 178, 2789, 3901, 1345, 2567, 178, 3234, 1678, 2456],
    [3712, 1456, 2789, 1234, 3401, 901, 2345, 178, 3567, 1234, 2789, 456, 1789, 3089, 1678, 2567, 456, 3156, 2012, 3489, 1456, 678, 2178, 901, 1789, 3312, 2089, 456, 1623, 2901, 178, 1789, 2456, 3712, 289, 1789, 2901, 3901, 234, 1912, 2345, 3234, 89, 2123, 3567, 901, 1567, 2901, 3567, 456, 1234, 2789, 456, 1789, 3401, 1089, 3567, 456, 2089, 3789, 678, 1567, 2901, 789],
    [567, 2123, 3901, 678, 2012, 2789, 1456, 3234, 712, 1901, 3089, 623, 2345, 3678, 234, 1012, 2789, 1567, 823, 2567, 1089, 3712, 2456, 3012, 1345, 567, 2345, 3456, 789, 2234, 3456, 1012, 623, 2567, 1234, 3567, 456, 1234, 2567, 3456, 567, 1234, 2567, 1789, 3234, 2012, 234, 1234, 2345, 823, 2901, 3901, 1567, 2901, 234, 1789, 2456, 1012, 2789, 567, 1234, 2345, 3678, 1234],
    [2901, 1678, 289, 3123, 1567, 3567, 567, 2567, 1089, 2456, 178, 1456, 2901, 789, 1901, 3401, 623, 1234, 3789, 289, 1789, 2234, 567, 1678, 3901, 2789, 1012, 1789, 3012, 1234, 567, 2789, 1901, 3234, 789, 2012, 3012, 1789, 678, 1789, 2901, 3789, 456, 2901, 567, 1456, 2789, 3901, 678, 1678, 3234, 178, 678, 2234, 3678, 567, 3234, 1789, 3234, 1567, 3901, 901, 178, 2567],
    [3456, 823, 2345, 1901, 456, 2234, 1234, 3789, 1789, 3234, 901, 2678, 3456, 1234, 2567, 178, 2123, 2901, 1456, 2678, 3234, 901, 2901, 3401, 234, 1234, 2178, 3567, 456, 1789, 2456, 3789, 178, 1345, 2678, 3678, 234, 2345, 3234, 1012, 234, 1567, 1789, 3234, 1234, 3567, 1012, 567, 2012, 3456, 567, 2567, 1234, 3012, 1234, 2789, 789, 2345, 178, 2012, 678, 2678, 3234, 1567],
    [1234, 3012, 1456, 2678, 3789, 1012, 2789, 289, 2234, 567, 1567, 3789, 289, 1789, 3012, 1567, 3567, 456, 1012, 3401, 456, 1567, 1234, 2012, 3089, 1567, 3789, 678, 2345, 3234, 901, 1234, 2567, 3567, 567, 1012, 1456, 2789, 456, 2567, 3567, 2456, 678, 2345, 2012, 234, 1789, 2901, 1234, 2789, 1012, 1789, 3567, 456, 1901, 3456, 1345, 3678, 901, 2789, 1234, 3567, 456, 2012],
    [178, 2567, 789, 3234, 567, 1789, 3234, 1456, 3012, 1901, 2901, 456, 2123, 678, 2345, 789, 2789, 1789, 2345, 1789, 2178, 3789, 2567, 789, 1901, 456, 2567, 1234, 901, 1567, 3012, 2012, 456, 1901, 2901, 2234, 3456, 1789, 3789, 1234, 789, 1012, 3234, 567, 3456, 2678, 3234, 456, 1567, 3789, 234, 2901, 2123, 678, 2567, 178, 2012, 567, 2456, 3456, 178, 1789, 2901, 789],
    [3678, 1789, 2012, 1234, 2345, 2567, 623, 1012, 2345, 678, 3401, 1234, 3012, 1456, 3401, 1234, 3234, 567, 3089, 678, 1234, 289, 1345, 3234, 2789, 3456, 1678, 3901, 2678, 3567, 234, 1234, 2789, 3234, 678, 1678, 789, 2567, 289, 1678, 2901, 3567, 1567, 2012, 1234, 678, 1234, 2123, 3234, 901, 1456, 3234, 789, 3234, 1234, 3012, 2789, 1234, 1678, 567, 2234, 1012, 3234, 1234],
    [567, 2901, 3456, 456, 1567, 3678, 1901, 2789, 3567, 1234, 1789, 2456, 567, 1901, 2123, 178, 2012, 1012, 1567, 2456, 2901, 3567, 2012, 623, 1012, 234, 2234, 789, 178, 1234, 1678, 3678, 623, 1456, 3012, 2234, 3234, 1234, 3012, 2234, 456, 234, 1234, 2789, 3901, 1567, 2567, 3678, 678, 2345, 567, 2012, 1456, 2567, 1789, 901, 3567, 2012, 3789, 1012, 2901, 3567, 567, 2567],
    [1234, 1456, 789, 2789, 1012, 234, 3123, 567, 1678, 2012, 3123, 789, 2789, 3234, 901, 2678, 3456, 2567, 3678, 901, 1789, 456, 1567, 2901, 3789, 1789, 3012, 1456, 2901, 3901, 789, 2456, 2012, 3789, 234, 1234, 567, 1901, 678, 1456, 3234, 1789, 2567, 456, 1234, 3089, 789, 1234, 1789, 3012, 2789, 3567, 234, 3789, 456, 2345, 456, 1567, 289, 2567, 789, 1567, 1901, 3789],
    [3012, 2234, 1901, 3234, 2123, 1456, 2567, 3789, 289, 2567, 901, 1456, 178, 1234, 3567, 1456, 789, 289, 1234, 2234, 3089, 2678, 3234, 1234, 678, 2345, 567, 2567, 1012, 567, 2234, 1234, 289, 1123, 2567, 3567, 2567, 2789, 3789, 2789, 1012, 901, 3456, 1678, 2012, 456, 1901, 2789, 3456, 178, 1234, 678, 1567, 2012, 1234, 3012, 1789, 2901, 1012, 3234, 1789, 3089, 2567, 178],
    [456, 3567, 1012, 567, 2789, 678, 1789, 1012, 1234, 3234, 1789, 2345, 3012, 2234, 567, 1789, 2345, 1789, 3234, 567, 1234, 789, 178, 1789, 2901, 3456, 1234, 3678, 1789, 2678, 3234, 3567, 1567, 2901, 789, 1567, 178, 1234, 456, 1234, 3567, 2123, 567, 2789, 3234, 2345, 3234, 567, 901, 2567, 3901, 2345, 3234, 789, 2789, 567, 3234, 456, 2234, 678, 2345, 456, 1234, 2901],
    [2345, 1567, 2456, 3678, 1234, 3234, 2234, 3456, 2012, 456, 2901, 623, 1567, 3789, 1234, 2901, 3012, 678, 2012, 2789, 1678, 2567, 3567, 2456, 456, 1567, 1901, 234, 901, 1456, 456, 901, 1789, 3234, 2234, 3456, 2901, 3234, 1789, 2567, 789, 1456, 3789, 1234, 789, 1234, 1678, 1456, 1789, 1234, 567, 1234, 901, 2234, 3456, 1234, 1789, 2567, 3789, 1234, 3567, 1567, 3678, 1012],
    [789, 3012, 289, 1789, 901, 2012, 456, 1234, 2789, 1234, 3456, 1012, 2678, 289, 901, 2178, 456, 1456, 3456, 456, 3234, 1234, 901, 1234, 3123, 789, 2789, 3234, 2345, 3789, 2567, 3012, 2345, 567, 1234, 678, 1234, 567, 3012, 1012, 2234, 3234, 289, 1789, 2567, 3567, 2234, 3012, 2789, 3456, 2234, 2901, 3678, 1567, 234, 2012, 3012, 1012, 567, 1789, 2901, 234, 2012, 2456],
    [1901, 2789, 1234, 3234, 2567, 3567, 1567, 3089, 567, 1789, 2234, 178, 1789, 3234, 1567, 3567, 1012, 2789, 1234, 1012, 2012, 289, 2789, 1789, 2012, 2234, 1234, 456, 1234, 567, 1234, 1678, 789, 2678, 3789, 2012, 2345, 1789, 2345, 3567, 456, 1234, 2012, 2901, 456, 1012, 789, 456, 1234, 678, 1567, 178, 1234, 789, 2901, 3567, 678, 2345, 3234, 2234, 567, 1012, 3234, 789],
    [3234, 567, 1678, 2012, 678, 1234, 2456, 789, 2234, 3234, 901, 2901, 1234, 2456, 678, 2234, 789, 3234, 2234, 3789, 1567, 3456, 567, 3234, 901, 3678, 1567, 3012, 2012, 3234, 2789, 3901, 2234, 1234, 456, 1234, 3234, 678, 2901, 1234, 1789, 3012, 678, 1234, 3234, 1789, 2901, 3567, 2012, 3234, 2789, 3234, 2567, 3456, 1234, 456, 1901, 789, 1456, 3012, 1789, 2789, 1456, 2123],
    [1012, 2456, 3789, 456, 2901, 3789, 1789, 1012, 2901, 1456, 567, 3456, 456, 3012, 1012, 1789, 3012, 178, 567, 1234, 901, 2178, 1234, 2345, 1456, 178, 2567, 789, 1789, 678, 1234, 289, 1012, 3234, 1678, 2567, 3567, 1234, 456, 3234, 2567, 567, 2567, 3678, 567, 2012, 1234, 567, 1456, 901, 456, 1012, 567, 1234, 1789, 2789, 3234, 2567, 234, 2567, 456, 3456, 678, 3567],
    [2678, 178, 1234, 1567, 2234, 289, 3234, 2345, 3567, 234, 2012, 1678, 2345, 1789, 2789, 3567, 2456, 1456, 2901, 2567, 3234, 678, 2789, 3567, 789, 2901, 3456, 1234, 3234, 2345, 3567, 1789, 2567, 456, 2901, 178, 789, 1789, 2234, 789, 1234, 1789, 3234, 1234, 1789, 2567, 3234, 1789, 2789, 3567, 1789, 3234, 1789, 2901, 3012, 567, 1234, 1012, 3789, 1234, 1012, 2012, 1234, 2789],
    [3901, 1789, 2789, 789, 3456, 1234, 1567, 678, 1234, 2678, 3789, 789, 3234, 567, 234, 1234, 623, 901, 3678, 456, 1234, 1567, 178, 1901, 2234, 456, 1234, 901, 567, 1012, 789, 2012, 3234, 1234, 3567, 1567, 3012, 2901, 3567, 1567, 3456, 289, 901, 2789, 3012, 456, 1234, 3012, 234, 1234, 2234, 678, 2345, 456, 178, 2234, 3567, 1789, 901, 2345, 3234, 2567, 3789, 456],
    [901, 2234, 3234, 1234, 2012, 2567, 3012, 1901, 2901, 456, 1234, 1234, 2012, 1234, 2678, 3234, 1789, 2678, 1234, 1789, 2901, 3789, 2789, 3456, 1234, 3012, 1789, 2678, 3789, 2234, 3012, 456, 1234, 1789, 789, 2234, 456, 1234, 567, 2345, 1234, 2123, 1567, 456, 1456, 2234, 1789, 567, 2012, 3012, 567, 3567, 1234, 1567, 2567, 1789, 456, 2901, 2678, 567, 789, 1456, 1234, 2012],
    [1567, 456, 1012, 3567, 567, 1678, 234, 3456, 1012, 3234, 1678, 2789, 3456, 901, 1567, 3012, 456, 234, 3234, 789, 567, 1234, 567, 1012, 2012, 567, 2345, 178, 1456, 678, 1567, 2789, 3567, 2567, 3234, 1012, 3234, 1789, 2901, 789, 3012, 3789, 2567, 3234, 2789, 3567, 678, 2901, 3567, 1234, 1789, 2012, 2789, 3901, 789, 3234, 3012, 1234, 178, 1789, 3234, 2901, 3456, 1789],
    [2789, 3567, 1789, 2234, 2901, 3789, 1234, 2234, 567, 2012, 456, 1234, 289, 1789, 2234, 789, 2012, 1567, 2012, 2456, 3234, 2012, 2901, 3234, 1789, 3567, 1012, 3234, 2567, 3456, 2234, 789, 178, 1234, 456, 1789, 2567, 678, 1234, 3456, 456, 1234, 901, 178, 1234, 901, 1234, 1234, 789, 2345, 3234, 456, 567, 1234, 1234, 1456, 567, 2012, 3456, 1234, 567, 678, 234, 1234],
    [178, 1234, 2567, 456, 1234, 789, 2012, 3234, 1456, 2789, 3456, 1901, 2567, 3567, 1012, 3456, 1234, 2789, 3567, 1234, 456, 1456, 789, 1234, 456, 2012, 2789, 623, 901, 1234, 1234, 3012, 1567, 2901, 3012, 2012, 3567, 1456, 2012, 1789, 2234, 1567, 2345, 3012, 1789, 2345, 3234, 2234, 3012, 567, 1234, 1234, 3012, 2234, 3012, 2567, 3789, 901, 789, 2567, 2012, 1789, 3012, 2789],
    [3234, 1901, 789, 3123, 1567, 2567, 1234, 456, 1789, 178, 1234, 678, 234, 1234, 1456, 567, 2567, 678, 234, 901, 2789, 3456, 2234, 3012, 2345, 1567, 178, 1234, 2012, 3789, 2456, 678, 2345, 567, 1234, 789, 178, 901, 3234, 567, 3089, 789, 456, 1567, 456, 3012, 567, 1456, 1789, 2678, 2901, 3567, 789, 1567, 789, 234, 1234, 2345, 3012, 1234, 3456, 567, 1234, 567],
    [2012, 567, 2345, 1234, 3789, 901, 2901, 3456, 2234, 2901, 3234, 2345, 2789, 3234, 2678, 1789, 3234, 1234, 3012, 1789, 1567, 567, 1234, 567, 789, 2901, 3567, 2789, 3456, 456, 1234, 1789, 3234, 1789, 3789, 2345, 2567, 3456, 1234, 2567, 1234, 1789, 2678, 3234, 2789, 1234, 1789, 2901, 456, 3234, 178, 1234, 2012, 2789, 3234, 1789, 2012, 567, 1678, 456, 2234, 1012, 2456, 3567],
    [1234, 3012, 1678, 2678, 456, 1789, 2234, 567, 1012, 789, 1567, 456, 1234, 789, 123, 2012, 456, 1567, 2234, 2567, 3012, 2678, 3567, 1901, 3234, 1456, 1012, 567, 1234, 1678, 2901, 3456, 789, 2567, 234, 1234, 1234, 789, 1789, 678, 2901, 3234, 1234, 678, 1234, 567, 3012, 2234, 1234, 1789, 1567, 3234, 456, 1234, 567, 3012, 456, 2901, 3234, 2012, 3012, 1789, 789, 178],
    [567, 2234, 234, 3234, 2234, 3012, 1234, 3567, 2456, 3456, 2234, 1789, 3012, 2234, 3456, 901, 2789, 3678, 789, 178, 1234, 789, 234, 2234, 456, 2012, 2345, 3234, 2567, 3234, 567, 1234, 2012, 1234, 3012, 3678, 2789, 3234, 2234, 3567, 456, 567, 1789, 2567, 3456, 2012, 1234, 789, 3456, 567, 2789, 567, 3012, 2678, 1567, 2234, 1234, 1567, 789, 1234, 678, 2567, 3234, 2901],
    [3456, 1567, 2901, 789, 1234, 567, 1678, 456, 1234, 567, 2901, 3234, 567, 1456, 1789, 1234, 567, 1234, 2012, 3234, 2234, 1567, 2901, 3567, 1234, 3789, 789, 1789, 456, 1234, 2012, 3012, 2678, 456, 1567, 567, 1234, 456, 1234, 1012, 1789, 2345, 3012, 901, 234, 789, 2567, 3234, 1234, 2234, 3789, 1789, 234, 1234, 3789, 456, 3012, 3789, 456, 2789, 3567, 1234, 1234, 1234],
    [789, 1789, 3678, 1456, 2567, 3456, 2345, 2901, 1789, 3089, 1234, 178, 2012, 2789, 3012, 2567, 3234, 2567, 1234, 456, 901, 3012, 1234, 678, 1789, 901, 2567, 3012, 2234, 3567, 789, 1456, 3789, 1789, 2234, 2789, 3456, 1789, 2789, 3234, 2789, 678, 1234, 1567, 2789, 3567, 1234, 567, 1789, 2901, 567, 1234, 1567, 2567, 901, 2012, 1234, 2234, 1789, 234, 1012, 789, 2789, 3567],
    [2234, 456, 1234, 2012, 789, 1234, 789, 3234, 1234, 456, 1789, 2567, 3567, 456, 789, 178, 1012, 1789, 3456, 2901, 1678, 2345, 456, 2567, 3234, 2234, 178, 1234, 678, 1234, 2567, 234, 1234, 3234, 678, 1234, 1234, 678, 567, 1234, 178, 3456, 2789, 3234, 456, 1234, 2012, 2567, 456, 1234, 3012, 2789, 3234, 789, 3234, 567, 3567, 567, 3234, 2012, 3234, 2234, 178, 1234],
    [3012, 2789, 567, 3234, 2789, 3012, 1567, 2012, 2567, 2234, 3234, 1012, 1234, 1567, 2234, 2901, 3567, 567, 234, 789, 3234, 3789, 1789, 901, 1234, 1567, 3567, 2901, 3456, 1789, 3234, 1234, 2789, 567, 3567, 2012, 3234, 2567, 3234, 1789, 2567, 1012, 567, 1234, 1789, 3012, 789, 1234, 3234, 2012, 678, 456, 1234, 2012, 1567, 2789, 1234, 2012, 1234, 789, 567, 1678, 2901, 3234],
    [1234, 1789, 1234, 1456, 456, 1789, 2678, 456, 3456, 789, 1234, 2789, 3234, 2789, 3012, 678, 1234, 2012, 1567, 2567, 1234, 456, 2234, 3012, 2678, 3789, 456, 1234, 234, 567, 2012, 3567, 1234, 2012, 1234, 567, 1234, 901, 1234, 2901, 3234, 3789, 2234, 2901, 567, 2345, 3567, 2234, 567, 1234, 1789, 3456, 2567, 3678, 456, 178, 3012, 456, 3012, 2567, 1234, 3012, 567, 1234],
    [2567, 3456, 234, 2567, 3234, 1234, 901, 1234, 1567, 2012, 3567, 567, 178, 1234, 456, 1789, 2678, 3234, 901, 3012, 1789, 1234, 567, 1456, 789, 1234, 2012, 1789, 2567, 3012, 789, 456, 1789, 2567, 3234, 1789, 2901, 3567, 456, 678, 1234, 456, 1234, 1234, 3234, 789, 1234, 1789, 2789, 3234, 234, 1012, 1234, 234, 1234, 2567, 1567, 1789, 567, 1789, 3567, 789, 2345, 2012],
    [678, 2012, 1789, 3789, 678, 2901, 3012, 2345, 3234, 901, 1234, 1789, 2345, 3456, 2567, 3234, 456, 1234, 2234, 456, 678, 2789, 3456, 2567, 3234, 1901, 3012, 789, 3678, 1234, 2234, 3012, 2901, 1234, 456, 789, 1234, 1234, 2234, 1789, 2234, 3012, 1789, 3012, 567, 1789, 2678, 456, 1234, 567, 1567, 2789, 2012, 3012, 3234, 901, 3789, 2234, 3012, 234, 2012, 1234, 1234, 3567],
    [1234, 3234, 1234, 234, 1789, 567, 1234, 456, 1234, 2678, 3012, 2789, 789, 1234, 678, 1234, 1567, 3012, 1789, 3234, 1234, 1234, 178, 1234, 567, 234, 1456, 2345, 456, 1567, 3456, 567, 1234, 3789, 2234, 3012, 2567, 3789, 567, 3234, 901, 567, 2567, 456, 2234, 3234, 1234, 3234, 2012, 3234, 3234, 456, 567, 1234, 1234, 567, 1234, 456, 1234, 2789, 789, 2789, 3012, 789],
    [2789, 456, 2567, 1234, 3012, 2234, 3567, 2789, 1678, 456, 1234, 178, 2234, 2012, 2789, 3567, 2234, 789, 567, 2012, 2789, 3567, 2012, 1789, 2789, 3234, 2012, 3789, 1234, 2789, 234, 1789, 2345, 567, 1234, 678, 1234, 456, 1234, 1234, 2567, 1789, 3456, 1234, 1234, 567, 2012, 678, 1234, 789, 1234, 1789, 2345, 3567, 1789, 2789, 3012, 2901, 1678, 567, 3234, 1567, 567, 2234],
    [1567, 3567, 789, 1789, 2678, 789, 1234, 1901, 3234, 2234, 2901, 3234, 1456, 3234, 901, 234, 1234, 2567, 3234, 1234, 456, 901, 3234, 1234, 567, 1567, 789, 567, 1234, 1012, 2567, 3234, 1234, 3012, 1789, 2567, 3234, 2012, 2789, 3234, 789, 234, 1234, 2789, 3234, 1789, 3567, 2567, 3456, 2234, 2678, 3234, 678, 234, 901, 1234, 678, 234, 3234, 1234, 1234, 2234, 1789, 3234],
    [234, 2012, 2234, 3456, 456, 1456, 3012, 567, 1234, 456, 1234, 678, 567, 2567, 1789, 1567, 3012, 456, 1234, 1567, 2234, 1678, 567, 2678, 3789, 2234, 2901, 3012, 2345, 3567, 678, 1234, 2678, 456, 2901, 234, 1234, 678, 567, 1234, 1567, 2567, 3012, 456, 1234, 2234, 456, 1234, 789, 1234, 567, 1234, 1567, 2789, 3234, 2012, 3789, 1789, 567, 2567, 3789, 456, 2901, 678],
    [2901, 1234, 567, 1234, 2234, 2789, 2234, 2567, 3567, 1789, 3456, 2234, 1789, 3012, 3456, 2678, 789, 2012, 2789, 3456, 789, 2901, 3234, 1234, 234, 1234, 1567, 456, 1234, 1789, 2012, 3012, 901, 3234, 1234, 3567, 1789, 3012, 2234, 3456, 2789, 789, 1234, 1789, 3012, 678, 2789, 1789, 2567, 3012, 3456, 2567, 3012, 234, 1234, 456, 1234, 2567, 1234, 789, 1234, 1234, 3234, 1234],
    [789, 3234, 2789, 1789, 3789, 1234, 456, 1234, 901, 2012, 234, 2901, 1234, 456, 234, 1234, 1234, 3567, 1234, 178, 1234, 456, 1234, 1567, 2567, 3567, 2234, 3234, 2789, 456, 3234, 567, 1678, 1789, 567, 2234, 567, 1234, 1234, 678, 1234, 1234, 3234, 2567, 234, 1234, 3234, 567, 1234, 456, 789, 1234, 1234, 1567, 2567, 3234, 2012, 3234, 3012, 2234, 3012, 2012, 567, 2567],
    [1567, 456, 1234, 567, 1234, 2012, 3234, 1789, 3012, 2567, 1234, 567, 3234, 1789, 2789, 3234, 901, 567, 2234, 2567, 3012, 1789, 2678, 456, 901, 1234, 789, 1234, 567, 1234, 1234, 2345, 2567, 3456, 2789, 1234, 2789, 2567, 3567, 2567, 3234, 2012, 789, 567, 1789, 2567, 789, 2234, 1789, 2234, 3234, 2234, 3567, 789, 456, 1234, 789, 567, 1234, 456, 1234, 789, 1567, 3234],
    [3012, 2234, 3567, 2345, 2901, 678, 2567, 456, 1234, 1456, 3234, 1789, 2234, 3567, 567, 1789, 2345, 1456, 3234, 789, 1234, 567, 3234, 1789, 3234, 2012, 3456, 1567, 2012, 3234, 3012, 789, 234, 1234, 1234, 3234, 456, 1234, 456, 1234, 567, 1234, 1567, 2789, 3234, 1234, 3567, 1234, 3234, 567, 1234, 678, 1234, 2234, 3234, 2789, 2567, 3456, 1789, 2567, 3234, 2234, 3012, 789],
    [567, 1234, 901, 1234, 1234, 3456, 1234, 3234, 2789, 3789, 789, 456, 2567, 234, 1234, 3012, 678, 2789, 567, 2012, 2789, 1234, 234, 1234, 567, 2567, 456, 2901, 789, 1234, 567, 1789, 3234, 2012, 2567, 789, 1789, 3012, 1789, 2901, 3567, 2345, 3234, 456, 1234, 567, 1234, 456, 789, 1234, 2012, 3234, 3012, 456, 1234, 456, 1234, 234, 901, 1234, 567, 1234, 456, 2234],
    [2567, 1789, 3234, 2789, 567, 1678, 901, 1234, 567, 1234, 2012, 2901, 1234, 1678, 2678, 456, 1234, 3012, 1789, 1234, 3567, 1567, 2789, 3012, 1567, 1234, 3234, 1234, 3567, 2234, 3567, 2567, 1234, 678, 1234, 3234, 2234, 567, 2234, 789, 1234, 789, 1234, 1234, 2234, 3012, 1789, 2567, 3012, 2789, 567, 1234, 234, 1789, 2567, 1789, 3234, 1567, 2789, 3234, 1789, 2789, 1234, 3456],
    [456, 2901, 178, 1234, 3012, 2345, 2789, 2234, 1789, 3234, 1234, 3456, 567, 3234, 789, 1789, 2234, 178, 2567, 901, 456, 2234, 789, 2234, 3789, 789, 2012, 567, 1234, 789, 1234, 456, 1234, 2901, 3567, 567, 1234, 1234, 3234, 1567, 3234, 2567, 3567, 789, 1567, 2567, 789, 1234, 456, 1234, 1789, 3567, 2012, 567, 3234, 456, 789, 2234, 456, 567, 1234, 567, 2012, 1234],
    [3234, 1234, 2234, 789, 1789, 456, 3012, 1234, 456, 2567, 789, 1234, 1789, 1234, 2234, 3234, 567, 3234, 1234, 3234, 1234, 3012, 1234, 456, 1234, 2345, 1234, 2789, 3012, 1567, 2789, 3234, 1789, 789, 1234, 1789, 2789, 3456, 567, 2678, 789, 1234, 1234, 2012, 3234, 234, 3012, 2234, 2789, 3012, 456, 789, 3234, 1234, 1234, 2012, 3012, 1234, 3012, 1789, 3012, 2345, 3234, 789],
    [678, 1678, 3567, 2567, 3234, 1234, 567, 1567, 3567, 1234, 2012, 3012, 2567, 2901, 456, 1234, 1234, 2789, 678, 1789, 2678, 567, 2567, 1789, 3234, 567, 3567, 1234, 456, 234, 3234, 567, 2234, 3234, 2567, 3234, 456, 1234, 1234, 1234, 3234, 2234, 3012, 456, 1234, 1234, 1456, 456, 1234, 234, 2234, 2567, 1234, 2901, 678, 2789, 567, 1789, 567, 2567, 234, 1234, 567, 2567],
    [2012, 789, 1234, 456, 1234, 2789, 2012, 2901, 234, 1789, 2789, 456, 1234, 3567, 1567, 2567, 901, 1567, 3456, 234, 1234, 1789, 3567, 901, 2012, 1234, 789, 2234, 1789, 2012, 1234, 1789, 1234, 567, 1234, 678, 1567, 2901, 2234, 3234, 567, 789, 1234, 1789, 2789, 3234, 789, 2901, 1567, 3234, 1234, 3567, 456, 1567, 3567, 1234, 3234, 2567, 3234, 1234, 1234, 3567, 1789, 3234],
    [3456, 2234, 2901, 1678, 2345, 789, 3456, 1234, 3234, 567, 3234, 1234, 789, 234, 3234, 3012, 2345, 2012, 567, 2012, 2901, 3234, 234, 2234, 1234, 3012, 2567, 3234, 567, 3567, 678, 3012, 2567, 3012, 2012, 3012, 2567, 789, 3567, 456, 1234, 2567, 2901, 567, 1234, 567, 2012, 3567, 789, 567, 789, 1234, 2234, 789, 1234, 456, 1234, 456, 789, 1789, 2789, 789, 2234, 567],
    [1234, 567, 3234, 567, 3012, 1234, 1234, 567, 1567, 2234, 1234, 1789, 2678, 1789, 1234, 789, 456, 1234, 2789, 1234, 789, 1234, 1234, 3456, 1678, 567, 1234, 901, 1234, 2345, 1234, 234, 1234, 789, 1234, 456, 1234, 1234, 1234, 2012, 3456, 1234, 3234, 3567, 2234, 3234, 1234, 1234, 2234, 2012, 3012, 2234, 3012, 2567, 3234, 2789, 1789, 3012, 2234, 567, 234, 1234, 1234, 3012],
    [2678, 3789, 1234, 2012, 1234, 2567, 2789, 2234, 3234, 456, 3567, 2234, 567, 3234, 2234, 2789, 3567, 1234, 3234, 3567, 1678, 2567, 789, 567, 2345, 2789, 3234, 1789, 2901, 456, 1789, 2789, 3567, 1567, 2567, 3234, 1789, 3012, 2567, 789, 1234, 789, 567, 1234, 789, 567, 2678, 3234, 456, 1234, 456, 567, 1234, 234, 1234, 567, 234, 567, 3567, 1234, 3012, 2567, 3567, 456],
    [789, 1234, 456, 1567, 3567, 901, 3234, 1234, 789, 1234, 789, 1234, 1234, 456, 1234, 567, 1234, 456, 789, 234, 2234, 3789, 1567, 2012, 3567, 456, 1234, 567, 3456, 1234, 3234, 678, 1234, 234, 3234, 901, 567, 567, 1234, 1567, 2234, 3234, 1567, 2789, 1234, 1567, 789, 1234, 1567, 2567, 1789, 3234, 1789, 3567, 1567, 3012, 2234, 1789, 1234, 2012, 789, 1234, 789, 2234],
    [2234, 3234, 2789, 234, 1789, 456, 1234, 1789, 2567, 3012, 1789, 2901, 3234, 1789, 3012, 1789, 2012, 3012, 1567, 2567, 567, 1234, 234, 3234, 789, 1234, 2012, 234, 1234, 789, 2234, 1234, 3012, 1789, 789, 2234, 2789, 3234, 2901, 3234, 567, 789, 2567, 456, 3234, 2234, 3234, 2789, 3234, 789, 567, 1234, 567, 1234, 789, 234, 1234, 3234, 678, 3234, 567, 2234, 3234, 1234],
    [1234, 678, 1234, 3234, 2567, 2901, 3456, 567, 3567, 1234, 456, 3567, 567, 2567, 678, 2567, 567, 2567, 901, 1234, 3012, 1234, 2678, 1234, 1567, 2789, 3567, 1567, 2789, 3567, 567, 2567, 678, 2567, 3567, 1234, 567, 1234, 567, 1234, 1789, 2789, 3234, 1234, 567, 1234, 567, 1234, 567, 1234, 2789, 3234, 2789, 234, 2567, 1789, 2789, 567, 2012, 1234, 1789, 1234, 567, 2789],
    [3567, 1789, 2345, 567, 1234, 789, 1789, 2234, 234, 2012, 2234, 1234, 1234, 2012, 3234, 1234, 3456, 234, 3234, 2345, 789, 2012, 456, 1789, 3234, 567, 1234, 234, 1234, 234, 1234, 3234, 1234, 456, 1234, 789, 3234, 1789, 2234, 3012, 3567, 1234, 789, 1789, 2567, 3234, 2012, 3234, 2012, 3234, 234, 1234, 567, 3234, 1234, 3234, 456, 1234, 456, 3567, 234, 2901, 1678, 567],
    [456, 2901, 1234, 2789, 3012, 2234, 567, 3012, 1456, 2789, 3678, 901, 2567, 3456, 789, 1901, 2567, 1234, 567, 1789, 3012, 1234, 2901, 567, 1789, 2345, 3901, 1234, 2678, 3234, 789, 1567, 2901, 3678, 234, 2012, 1234, 3456, 789, 2234, 456, 3012, 1789, 234, 1234, 2901, 3456, 789, 2234, 1567, 3012, 456, 2012, 1789, 3567, 789, 2345, 1234, 3012, 789, 2567, 1234, 3012, 1789],
    [1789, 3456, 567, 1234, 789, 3567, 1789, 456, 2234, 1234, 567, 1789, 3234, 234, 1567, 3234, 456, 2901, 3567, 678, 2345, 789, 3456, 1234, 3012, 567, 1234, 789, 456, 1234, 2345, 3567, 567, 1234, 1789, 2901, 567, 1234, 2567, 3567, 1234, 789, 2567, 3012, 567, 1234, 789, 2567, 456, 3234, 1234, 2789, 3234, 456, 1234, 2678, 456, 1789, 567, 2012, 3567, 456, 1789, 2567],
    [2567, 234, 2012, 3234, 1567, 901, 2567, 3234, 789, 3012, 2345, 456, 1234, 2012, 2789, 678, 1234, 789, 1234, 2012, 1234, 3012, 178, 2234, 678, 1789, 2678, 3567, 2012, 3567, 901, 1234, 2234, 3012, 456, 3234, 1567, 3012, 234, 1234, 2012, 3234, 1234, 456, 1789, 2678, 3234, 1234, 3012, 789, 567, 1234, 567, 2012, 3012, 901, 3567, 2234, 3234, 1234, 901, 2234, 3234, 456],
    [3234, 1234, 789, 2456, 456, 2789, 1234, 1567, 2012, 567, 1234, 2901, 3567, 789, 3234, 1234, 3012, 2234, 3456, 567, 2678, 456, 1567, 2901, 3234, 456, 1234, 234, 1234, 789, 2567, 178, 1789, 789, 2567, 789, 2234, 789, 1789, 2789, 567, 1789, 567, 2234, 3456, 567, 1234, 1789, 567, 2012, 2345, 3567, 1234, 2789, 567, 1567, 234, 1234, 789, 2789, 456, 789, 1234, 2012],
    [901, 2678, 3567, 1234, 1789, 3234, 456, 2901, 3234, 1789, 456, 2234, 1234, 2567, 456, 1789, 567, 3012, 1234, 2901, 3567, 789, 2234, 3456, 789, 1234, 2012, 3678, 1567, 456, 3012, 2901, 567, 3234, 1234, 1789, 3012, 567, 2234, 1234, 3234, 2678, 789, 1234, 2012, 3234, 567, 2901, 1234, 3567, 789, 2234, 456, 1234, 2789, 3234, 901, 2567, 1234, 3567, 1234, 2567, 789, 3456],
    [2012, 567, 1789, 2901, 567, 1234, 2012, 789, 1234, 3012, 2678, 3567, 901, 3234, 1234, 2901, 2234, 789, 1789, 456, 1234, 2012, 567, 1234, 1789, 3012, 567, 234, 2234, 3234, 1234, 789, 1789, 456, 2567, 456, 2234, 1234, 3567, 456, 1234, 567, 3012, 2567, 789, 1234, 1789, 456, 2789, 1234, 456, 1234, 3012, 1789, 567, 1234, 2012, 456, 3234, 789, 2012, 3456, 1234, 678],
    [3567, 1234, 456, 3234, 2345, 3567, 1567, 3456, 567, 1234, 789, 1234, 1789, 567, 3012, 789, 1234, 3456, 2567, 3012, 678, 2789, 3234, 2567, 456, 2234, 2901, 1234, 901, 789, 2567, 3456, 234, 3012, 1234, 3234, 789, 3012, 789, 2789, 3234, 1789, 456, 1234, 3456, 2567, 234, 3234, 567, 3234, 2012, 2567, 789, 3234, 2345, 3012, 789, 1789, 567, 1234, 567, 1234, 2012, 2789],
    [789, 2567, 1234, 789, 1234, 901, 2678, 234, 2234, 2789, 3234, 2012, 2901, 2234, 456, 1567, 2567, 567, 1234, 789, 1789, 1234, 789, 1234, 3567, 1234, 789, 3567, 2567, 3234, 1234, 567, 1234, 1789, 789, 2012, 1234, 567, 1789, 1234, 567, 2234, 2789, 1789, 789, 1234, 1789, 1234, 1234, 789, 3567, 1234, 2234, 567, 1234, 456, 3234, 2567, 2012, 2789, 3234, 789, 3234, 1234],
]

# Blue noise tile size
_BLUE_NOISE_SIZE = 64


def _generate_dither_pattern(shade: int) -> list:
    """Generate a 64x64 dither pattern for a given shade level using blue noise.
    
    Blue noise produces visually pleasing dithering without the regular grid
    artifacts of Bayer ordered dithering. The frequency content is concentrated
    away from low frequencies, resulting in a more natural appearance.
    
    Args:
        shade: Shade level 0-16 (0=white, 16=black)
        
    Returns:
        64x64 list of 0s (white) and 1s (black)
    """
    # Map shade 0-16 to threshold 0-4096
    # shade 0 = threshold 0 (all white)
    # shade 16 = threshold 4096 (all black)
    threshold = shade * 256  # 0, 256, 512, ... 4096
    
    pattern = []
    for row in _BLUE_NOISE_64:
        pattern_row = []
        for val in row:
            # Pixel is black if blue noise value is less than threshold
            pattern_row.append(1 if val < threshold else 0)
        pattern.append(pattern_row)
    return pattern


# Pre-generate patterns for shade levels 0-16
DITHER_PATTERNS = {shade: _generate_dither_pattern(shade) for shade in range(17)}


class Widget(ABC):
    """Base class for all display widgets."""
    
    # Class-level flag indicating if this widget type is modal.
    # When a modal widget is present, only it is rendered.
    is_modal: bool = False
    
    def __init__(self, x: int, y: int, width: int, height: int, background_shade: int = 0):
        """Initialize a widget.
        
        Args:
            x: X position on display
            y: Y position on display
            width: Widget width in pixels
            height: Widget height in pixels
            background_shade: Dithered background shade 0-16 (0=white, 8=50% gray, 16=black)
        """
        self.x = x
        self.y = y
        self.width = width
        self.height = height
        self.visible = True  # Whether the widget should be rendered by the Manager
        self._background_shade = max(0, min(16, background_shade))
        self._last_rendered: Optional[Image.Image] = None
        self._scheduler: Optional['Scheduler'] = None
        self._update_callback: Optional[Callable[[bool], object]] = None
        log.debug(f"Widget.__init__(): Created {self.__class__.__name__} instance id={id(self)} at ({x}, {y}) size {width}x{height}")
    
    def set_scheduler(self, scheduler: 'Scheduler') -> None:
        """Set the scheduler for this widget to trigger updates."""
        self._scheduler = scheduler
        log.debug(f"Widget.set_scheduler(): {self.__class__.__name__} id={id(self)} scheduler set")
    
    def set_update_callback(self, callback: Callable[[bool], object]) -> None:
        """Set a callback to trigger Manager.update() when widget state changes.
        
        The callback should accept a 'full' boolean parameter and return a Future.
        This allows widgets to trigger full update cycles that render all widgets.
        """
        self._update_callback = callback
        log.debug(f"Widget.set_update_callback(): {self.__class__.__name__} id={id(self)} update callback set")
            
    def get_scheduler(self) -> Optional['Scheduler']:
        """Get the scheduler for this widget."""
        return self._scheduler
    
    def request_update(self, full: bool = False, forced: bool = False):
        """Request a display update.
        
        This method should be called by widgets when their state changes
        and they need the display to refresh. It calls Manager.update() which:
        1. Renders all widgets to the framebuffer
        2. Submits the complete framebuffer to the scheduler
        
        If the widget is not visible and forced is False, the request is ignored
        since hidden widgets are not rendered and would cause unnecessary update cycles.
        
        Args:
            full: If True, force a full refresh instead of partial refresh.
            forced: If True, ignore visibility check (used by show/hide to update display).
        
        Returns:
            Future: A Future that completes when the display refresh finishes.
            Returns None if update callback is not available or widget is hidden.
        
        Note:
            Widgets should NOT call the scheduler directly. The Manager must
            render all widgets first before submitting to ensure consistent state.
        """
        # Ignore update requests from hidden widgets (unless forced)
        if not self.visible and not forced:
            log.debug(f"Widget.request_update(): {self.__class__.__name__} id={id(self)} ignored (widget is hidden)")
            return None
        
        if full:
            log.warning(f"Widget.request_update(): {self.__class__.__name__} requesting FULL refresh (will cause flashing)")
        else:
            log.debug(f"Widget.request_update(): {self.__class__.__name__} id={id(self)} requesting partial update")
        
        if self._update_callback is not None:
            return self._update_callback(full)
        
        # No callback available - cannot update without Manager
        log.debug(f"Widget.request_update(): {self.__class__.__name__} id={id(self)} ignored (no update callback)")
        return None
    
    def set_background_shade(self, shade: int) -> None:
        """Set the background shade level.
        
        Args:
            shade: Grayscale level 0-16 (0=white, 8=50% gray, 16=black)
        """
        shade = max(0, min(16, shade))
        if shade != self._background_shade:
            self._background_shade = shade
            self._last_rendered = None
            self.request_update(full=False)
    
    def create_background_image(self) -> Image.Image:
        """Create a new image with the widget's dithered background.
        
        Subclasses should call this at the start of render() instead of
        Image.new("1", (self.width, self.height), 255) to get a dithered
        background based on background_shade.
        
        Uses a 64x64 blue noise texture for dithering, which provides
        visually pleasing results without the regular grid artifacts of
        Bayer ordered dithering.
        
        Returns:
            A new 1-bit image with the dithered background pattern applied.
        """
        img = Image.new("1", (self.width, self.height), 255)
        
        if self._background_shade == 0:
            return img  # Pure white, no dithering needed
        
        pattern = DITHER_PATTERNS.get(self._background_shade, DITHER_PATTERNS[0])
        pixels = img.load()
        for y in range(self.height):
            pattern_row = pattern[y % _BLUE_NOISE_SIZE]
            for x in range(self.width):
                if pattern_row[x % _BLUE_NOISE_SIZE] == 1:
                    pixels[x, y] = 0  # Black pixel
        
        return img
    
    @abstractmethod
    def render(self) -> Image.Image:
        """Render the widget content. Must return an image of size (width, height)."""
        pass
    
    def get_mask(self) -> Optional[Image.Image]:
        """Get a mask for transparent compositing. Returns None if not needed."""
        return None
    
    def show(self) -> None:
        """Show the widget (make it visible).
        
        When visible, the widget will be rendered by the Manager.
        Triggers a display update to reflect the change.
        """
        if not self.visible:
            self.visible = True
            self._last_rendered = None  # Force re-render
            log.info(f"Widget.show(): {self.__class__.__name__} id={id(self)} now visible")
            self.request_update(full=False, forced=True)
    
    def hide(self) -> None:
        """Hide the widget (make it invisible).
        
        When hidden, the widget will not be rendered by the Manager.
        The widget remains in the display manager and continues any
        background processing (e.g., analysis), but its region on the
        display will be left for other widgets or background.
        Triggers a display update to reflect the change.
        """
        if self.visible:
            self.visible = False
            self._last_rendered = None
            log.info(f"Widget.hide(): {self.__class__.__name__} id={id(self)} now hidden")
            self.request_update(full=False, forced=True)
    
    def stop(self) -> None:
        """Stop the widget and perform cleanup tasks.
        
        This method should be overridden by widgets that have background threads,
        timers, or other resources that need cleanup. The default implementation
        does nothing.
        
        This method is called by Manager.shutdown() to ensure proper cleanup
        of all widgets before the display is shut down.
        """
        log.debug(f"Widget.stop(): {self.__class__.__name__} id={id(self)} stop() called")