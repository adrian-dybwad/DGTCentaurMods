{% extends "base.html" %}

{% block mainpage %}

<div class="settings-container">
  <!-- Sidebar Navigation -->
  <div class="settings-sidebar">
    <nav class="settings-nav">
      <a class="settings-nav-item active" data-section="presets" onclick="showSection('presets')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        </span>
        <span>Presets</span>
      </a>
      <a class="settings-nav-item" data-section="identity" onclick="showSection('identity')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        </span>
        <span>Identity</span>
      </a>
      <a class="settings-nav-item" data-section="elo" onclick="showSection('elo')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
        </span>
        <span>ELO</span>
      </a>
      <a class="settings-nav-item" data-section="weights" onclick="showSection('weights')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
        </span>
        <span>Weights</span>
      </a>
      <a class="settings-nav-item" data-section="piecevalues" onclick="showSection('piecevalues')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 22H5v-2h14v2M12 2c-2.67 0-8 1.34-8 4v12l8-4 8 4V6c0-2.66-5.33-4-8-4z"/></svg>
        </span>
        <span>Piece Values</span>
      </a>
      <a class="settings-nav-item" data-section="pawnstructure" onclick="showSection('pawnstructure')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7z"/></svg>
        </span>
        <span>Pawn Structure</span>
      </a>
      <a class="settings-nav-item" data-section="material" onclick="showSection('material')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
        </span>
        <span>Material</span>
      </a>
      <a class="settings-nav-item" data-section="patterns" onclick="showSection('patterns')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
        </span>
        <span>Patterns</span>
      </a>
      <a class="settings-nav-item" data-section="export" onclick="showSection('export')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        </span>
        <span>Export</span>
      </a>
    </nav>
  </div>
  
  <!-- Settings Content -->
  <div class="settings-content">
    
    <!-- PRESETS SECTION -->
    <div id="section-presets" class="settings-section active">
      <div class="settings-header">
        <h2 class="settings-title">Rodent IV Personality Creator</h2>
        <p class="settings-description">Create custom personalities for the Rodent IV chess engine</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <h3 class="settings-group-title">Character Presets</h3>
          <p class="settings-row-help" style="margin-bottom: 1rem;">Load a complete personality preset to get started</p>
          
          <div id="preset-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
            <!-- Buttons generated by JS -->
          </div>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">Playing Styles</h3>
          <p class="settings-row-help" style="margin-bottom: 1rem;">Apply style modifications to your current configuration</p>
          
          <div id="style-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
            <!-- Buttons generated by JS -->
          </div>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">Reset</h3>
          <button class="button is-warning" onclick="RodentTuner.loadPreset('default')">Reset to Default</button>
        </div>
      </div>
    </div>

    <!-- IDENTITY SECTION -->
    <div id="section-identity" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Character Identity</h2>
        <p class="settings-description">Name and describe your personality</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-row">
          <div class="settings-row-info">
            <div class="settings-row-label">Character Name</div>
            <div class="settings-row-help">Name of the playing character</div>
          </div>
          <div class="settings-row-control">
            <input class="input" type="text" id="CharacterName" value="RodentIVTuner">
          </div>
        </div>
        
        <div class="settings-row">
          <div class="settings-row-info">
            <div class="settings-row-label">Author</div>
            <div class="settings-row-help">Name of the personality author</div>
          </div>
          <div class="settings-row-control">
            <input class="input" type="text" id="Author" value="RodentIVTuner">
          </div>
        </div>
        
        <div class="settings-row">
          <div class="settings-row-info">
            <div class="settings-row-label">Converted By</div>
            <div class="settings-row-help">Name of the converter (if applicable)</div>
          </div>
          <div class="settings-row-control">
            <input class="input" type="text" id="Converter" value="RodentIVTuner">
          </div>
        </div>
        
        <div class="settings-row">
          <div class="settings-row-info">
            <div class="settings-row-label">Description</div>
            <div class="settings-row-help">Brief description of the character's playing style</div>
          </div>
          <div class="settings-row-control" style="flex: 2;">
            <textarea class="textarea" id="Description" placeholder="Describe the playing style..." maxlength="120" rows="2">aggressive Pawn mover</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- ELO SECTION -->
    <div id="section-elo" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">ELO Settings</h2>
        <p class="settings-description">Configure engine playing strength</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-row">
          <div class="settings-row-info">
            <div class="settings-row-label">Limit Strength</div>
            <div class="settings-row-help">Enable ELO-limited play mode</div>
          </div>
          <div class="settings-row-control">
            <div class="select">
              <select id="UCI_LimitStrength">
                <option value="true">true</option>
                <option value="false" selected>false</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="settings-row">
          <div class="settings-row-info">
            <div class="settings-row-label">ELO Rating</div>
            <div class="settings-row-help">Target ELO (800-2800)</div>
          </div>
          <div class="settings-row-control">
            <input class="input" type="number" id="UCI_Elo" value="2800" min="800" max="2800">
          </div>
        </div>
      </div>
    </div>

    <!-- WEIGHTS SECTION -->
    <div id="section-weights" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Evaluation Weights</h2>
        <p class="settings-description">Configure how the engine values different aspects of the position</p>
      </div>
      
      <div class="settings-card" id="weights-form">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- PIECE VALUES SECTION -->
    <div id="section-piecevalues" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Piece Values</h2>
        <p class="settings-description">Configure piece values for middlegame and endgame</p>
      </div>
      
      <div class="settings-card" id="piecevalues-form">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- PAWN STRUCTURE SECTION -->
    <div id="section-pawnstructure" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Pawn Structure</h2>
        <p class="settings-description">Configure pawn-related evaluation parameters</p>
      </div>
      
      <div class="settings-card" id="pawnstructure-form">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- MATERIAL SECTION -->
    <div id="section-material" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Material Imbalances</h2>
        <p class="settings-description">Configure piece combination preferences</p>
      </div>
      
      <div class="settings-card" id="material-form">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- PATTERNS SECTION -->
    <div id="section-patterns" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Patterns & Others</h2>
        <p class="settings-description">Configure pattern recognition and search settings</p>
      </div>
      
      <div class="settings-card" id="patterns-form">
        <!-- Generated by JS -->
      </div>
    </div>

    <!-- EXPORT SECTION -->
    <div id="section-export" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Export & Import</h2>
        <p class="settings-description">Save or load personality files</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <h3 class="settings-group-title">Export Personality</h3>
          <p class="settings-row-help" style="margin-bottom: 1rem;">Download your personality configuration file</p>
          
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="button is-success" onclick="RodentTuner.exportPersonality()">
              <span>Download Personality File</span>
            </button>
            <button class="button is-info" onclick="RodentTuner.exportUCI()">
              <span>Download UCI Config</span>
            </button>
          </div>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">Import Personality</h3>
          <p class="settings-row-help" style="margin-bottom: 1rem;">Upload a personality file created with this tool</p>
          
          <form method="POST" action="" enctype="multipart/form-data">
            <div class="file has-name is-fullwidth" style="margin-bottom: 1rem;">
              <label class="file-label">
                <input class="file-input" type="file" name="file" id="file-upload">
                <span class="file-cta">
                  <span class="file-label">Choose file...</span>
                </span>
                <span class="file-name" id="file-name">No file selected</span>
              </label>
            </div>
            <button class="button is-primary" type="submit">Upload</button>
          </form>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">Documentation</h3>
          <p class="settings-row-help">
            For detailed documentation on personality parameters, see:
          </p>
          <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
            <li><a href="https://github.com/nescitus/Rodent_III/blob/master/docs/about_personalities.pdf" target="_blank" rel="noopener">Rodent III Personalities Guide</a></li>
            <li><a href="https://github.com/nescitus/rodent-iv/blob/master/docs/FinalRodent.pdf" target="_blank" rel="noopener">Rodent IV Official Manual</a></li>
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/**
 * Rodent IV Personality Tuner
 * 
 * Data-driven approach: all personality settings are defined as configuration objects,
 * UI is generated from schema, and presets are plain data objects applied uniformly.
 */
const RodentTuner = (function() {
  'use strict';
  
  // PST style mapping - name to numeric value for export
  const PST_STYLES = { quirky: 0, classic: 1, normal: 2, blunt: 3, forward: 4 };
  
  // Field definitions - each field has id, label, help text, type, default, min/max
  const FIELD_SCHEMA = {
    // Identity fields (handled separately in HTML)
    identity: [
      { id: 'CharacterName', label: 'Character Name', default: 'RodentIVTuner' },
      { id: 'Author', label: 'Author', default: 'RodentIVTuner' },
      { id: 'Converter', label: 'Converted By', default: 'RodentIVTuner' },
      { id: 'Description', label: 'Description', default: 'aggressive Pawn mover' }
    ],
    
    weights: {
      'Attack & Mobility': [
        { id: 'Material', label: 'Material', help: 'Influence of material advantage (default 100)', default: 100, min: 0, max: 500 },
        { id: 'OwnAttack', label: 'Own Attack', help: "Program's threats against enemy king", default: 100, min: 0, max: 500 },
        { id: 'OppAttack', label: 'Opponent Attack', help: "Opponent's threats against program's king", default: 100, min: 0, max: 500 },
        { id: 'OwnMobility', label: 'Own Mobility', help: 'Higher values = pursue active play', default: 50, min: 0, max: 500 },
        { id: 'OppMobility', label: 'Opponent Mobility', help: 'Higher values = restrict opponent', default: 50, min: 0, max: 500 },
        { id: 'FlatMobility', label: 'Flat Mobility', help: 'Symmetric mobility component', default: 50, min: 0, max: 500 }
      ],
      'Positional Factors': [
        { id: 'KingTropism', label: 'King Tropism', help: 'Bonus for pieces near enemy king (default 20)', default: 20, min: -50, max: 500 },
        { id: 'PiecePressure', label: 'Piece Pressure', help: 'Weight of attacking/defending pieces', default: 109, min: 0, max: 500 },
        { id: 'Lines', label: 'Lines', help: 'Semi-open/open files and 7th rank', default: 100, min: 0, max: 500 },
        { id: 'Outposts', label: 'Outposts', help: 'Good squares for minor pieces', default: 78, min: 0, max: 500 },
        { id: 'Space', label: 'Space', help: 'Space advantage weight', default: 0, min: 0, max: 500 }
      ],
      'Piece-Square Tables': [
        { id: 'PrimaryPstStyle', label: 'Primary PST Style', help: 'Primary piece positioning style', type: 'select', options: ['quirky', 'classic', 'normal', 'blunt', 'forward'], default: 'quirky' },
        { id: 'PrimaryPstWeight', label: 'Primary PST Weight', help: 'Influence of primary PST', default: 58, min: 0, max: 500 },
        { id: 'SecondaryPstStyle', label: 'Secondary PST Style', help: 'Secondary piece positioning style', type: 'select', options: ['quirky', 'classic', 'normal', 'blunt', 'forward'], default: 'classic' },
        { id: 'SecondaryPstWeight', label: 'Secondary PST Weight', help: 'Influence of secondary PST', default: 40, min: 0, max: 500 }
      ]
    },
    
    piecevalues: {
      'Middlegame Values': [
        { id: 'PawnValueMg', label: 'Pawn (mg)', default: 90, min: 0, max: 1200 },
        { id: 'KnightValueMg', label: 'Knight (mg)', default: 380, min: 0, max: 1200 },
        { id: 'BishopValueMg', label: 'Bishop (mg)', default: 390, min: 0, max: 1200 },
        { id: 'RookValueMg', label: 'Rook (mg)', default: 530, min: 0, max: 1200 },
        { id: 'QueenValueMg', label: 'Queen (mg)', default: 1160, min: 0, max: 1200 },
        { id: 'BishopPairMg', label: 'Bishop Pair (mg)', default: 51, min: -100, max: 100 }
      ],
      'Endgame Values': [
        { id: 'PawnValueEg', label: 'Pawn (eg)', default: 110, min: 0, max: 1200 },
        { id: 'KnightValueEg', label: 'Knight (eg)', default: 360, min: 0, max: 1200 },
        { id: 'BishopValueEg', label: 'Bishop (eg)', default: 370, min: 0, max: 1200 },
        { id: 'RookValueEg', label: 'Rook (eg)', default: 650, min: 0, max: 1200 },
        { id: 'QueenValueEg', label: 'Queen (eg)', default: 1190, min: 0, max: 1200 },
        { id: 'BishopPairEg', label: 'Bishop Pair (eg)', default: 51, min: -100, max: 100 }
      ],
      'Contempt & Keep Preferences': [
        { id: 'Contempt', label: 'Contempt', help: 'How much worse position engine will play on', default: 0, min: -250, max: 250 },
        { id: 'KeepPawn', label: 'Keep Pawn', help: 'Preference to keep pawns (+) or exchange (-)', default: 0, min: -200, max: 200 },
        { id: 'KeepKnight', label: 'Keep Knight', help: 'Preference to keep knights (+) or exchange (-)', default: 0, min: -200, max: 200 },
        { id: 'KeepBishop', label: 'Keep Bishop', help: 'Preference to keep bishops (+) or exchange (-)', default: 0, min: -200, max: 200 },
        { id: 'KeepRook', label: 'Keep Rook', help: 'Preference to keep rooks (+) or exchange (-)', default: 0, min: -200, max: 200 },
        { id: 'KeepQueen', label: 'Keep Queen', help: 'Preference to keep queens (+) or exchange (-)', default: 0, min: -200, max: 200 }
      ]
    },
    
    pawnstructure: {
      'General Pawn Weights': [
        { id: 'PassedPawns', label: 'Passed Pawns', help: 'Weight of passed pawn evaluation', default: 100, min: 0, max: 500 },
        { id: 'PawnStructure', label: 'Pawn Structure', help: 'Weight of pawn structure evaluation', default: 100, min: 0, max: 500 },
        { id: 'PawnMass', label: 'Pawn Mass', help: 'Weight of pawn support for each other', default: 100, min: 0, max: 500 },
        { id: 'PawnChains', label: 'Pawn Chains', help: 'Weight of pawn chain evaluation', default: 100, min: 0, max: 500 },
        { id: 'PawnShield', label: 'Pawn Shield', help: 'Value of pawns in front of own king', default: 119, min: 0, max: 500 },
        { id: 'PawnStorm', label: 'Pawn Storm', help: 'Value of pawns approaching enemy king', default: 99, min: 0, max: 500 }
      ],
      'Pawn Weaknesses': [
        { id: 'DoubledPawnMg', label: 'Doubled (mg)', default: -8, min: -100, max: 0 },
        { id: 'DoubledPawnEg', label: 'Doubled (eg)', default: -21, min: -100, max: 0 },
        { id: 'IsolatedPawnMg', label: 'Isolated (mg)', default: -7, min: -100, max: 0 },
        { id: 'IsolatedPawnEg', label: 'Isolated (eg)', default: -7, min: -100, max: 0 },
        { id: 'IsolatedOnOpenMg', label: 'Isolated on Open (mg)', default: -13, min: -100, max: 0 },
        { id: 'BackwardPawnMg', label: 'Backward (mg)', default: -2, min: -100, max: 0 },
        { id: 'BackwardPawnEg', label: 'Backward (eg)', default: -1, min: -100, max: 0 },
        { id: 'BackwardOnOpenMg', label: 'Backward on Open (mg)', default: -10, min: -100, max: 0 },
        { id: 'blockedcpawn', label: 'Blocked C Pawn', default: -17, min: -100, max: 0 }
      ]
    },
    
    material: {
      'Material Imbalances': [
        { id: 'KnightPair', label: 'Knight Pair', help: 'Penalty for having two knights (default -1)', default: -1, min: -100, max: 100 },
        { id: 'RookPair', label: 'Rook Pair', help: 'Penalty for having two rooks (default -11)', default: -11, min: -100, max: 100 },
        { id: 'KnightLikesClosed', label: 'Knight Likes Closed', help: 'Bonus per pawn with knight; higher = closed positions', default: 6, min: 0, max: 10 },
        { id: 'RookLikesOpen', label: 'Rook Likes Open', help: 'Penalty per pawn when having a rook', default: 0, min: 0, max: 10 },
        { id: 'ExchangeImbalance', label: 'Exchange Imbalance', help: 'Bonus for exchange advantage', default: 10, min: -100, max: 100 },
        { id: 'MinorVsQueen', label: 'Minor vs Queen', help: 'Bonus for minors confronting enemy queen', default: 10, min: -100, max: 100 }
      ]
    },
    
    patterns: {
      'Patterns': [
        { id: 'FianchBase', label: 'Fianchetto Base', default: 13, min: 0, max: 100 },
        { id: 'FianchKing', label: 'Fianchetto King', default: 20, min: 0, max: 100 },
        { id: 'ReturningB', label: 'Returning Bishop', default: 10, min: 0, max: 100 }
      ],
      'Search Settings': [
        { id: 'SlowMover', label: 'Slow Mover', help: 'Time management (default 100)', default: 100, min: 10, max: 500 },
        { id: 'Selectivity', label: 'Selectivity', help: 'Search selectivity (default 175)', default: 175, min: 0, max: 200 },
        { id: 'SearchSkill', label: 'Search Skill', help: 'Search skill level (0-10)', default: 10, min: 0, max: 10 },
        { id: 'BookFilter', label: 'Book Filter', help: 'Opening book filtering', default: 20, min: 0, max: 100 }
      ],
      'Opening Books': [
        { id: 'GuideBookFile', label: 'Guide Book File', type: 'text', default: 'guide/guide.bin' },
        { id: 'MainBookFile', label: 'Main Book File', type: 'text', default: 'rodent.bin' }
      ]
    },
    
    elo: [
      { id: 'UCI_LimitStrength', label: 'Limit Strength', type: 'select', options: ['true', 'false'], default: 'false' },
      { id: 'UCI_Elo', label: 'ELO Rating', default: 2800, min: 800, max: 2800 }
    ]
  };
  
  // Preset definitions - only specify values that differ from defaults
  const PRESETS = {
    default: {
      name: 'Default',
      description: 'Default Rodent IV settings'
    },
    
    ampere: {
      name: 'AmpereRT',
      author: 'RodentIVTuner',
      description: 'attacker that cares for pawn structure',
      OwnAttack: 160, OwnMobility: 100, OppMobility: 70, FlatMobility: 25,
      Space: 100, PassedPawns: 125, PawnStructure: 150,
      DoubledPawnMg: -10, BackwardPawnMg: -4, BackwardPawnEg: -3, BackwardOnOpenMg: -9,
      PrimaryPstStyle: 'normal', SecondaryPstStyle: 'normal',
      GuideBookFile: 'guide/active.bin'
    },
    
    cloe: {
      name: 'CloeRT',
      author: 'RodentIVTuner',
      description: 'Cloe likes closed positions',
      PawnShield: 150, PawnStorm: 120, OppMobility: 60,
      Lines: 120, Outposts: 90, Space: 100,
      PawnMass: 150, PawnChains: 150, KnightLikesClosed: 7, KeepPawn: 1,
      PrimaryPstStyle: 'normal',
      GuideBookFile: 'guide/closed.bin'
    },
    
    deborah: {
      name: 'DeborahRT',
      author: 'RodentIVTuner',
      description: 'defensive player who likes bishops',
      BishopValueMg: 400, BishopValueEg: 380,
      OwnAttack: 85, OppAttack: 115, PiecePressure: 125,
      KnightLikesClosed: 5, RookLikesOpen: 3,
      PrimaryPstStyle: 'classic', SecondaryPstStyle: 'quirky',
      GuideBookFile: 'guide.bin'
    },
    
    grumpy: {
      name: 'GrumpyRT',
      author: 'by Pawel Koziol',
      description: 'attack, restraint, contempt, likes blocked positions',
      KnightValueMg: 385, KnightValueEg: 365, BishopPairMg: 41,
      OwnAttack: 120, OppMobility: 70, Space: 100,
      KnightLikesClosed: 8, KeepPawn: 1,
      GuideBookFile: 'guide/grandpa.bin'
    },
    
    strangler: {
      name: 'StranglerRT',
      author: 'adapted from Brendan J. Norman personality for Rodent III',
      description: '',
      RookValueMg: 500, RookValueEg: 620,
      OwnAttack: 300, KingTropism: 35, PawnShield: 120,
      Material: 90, OppMobility: 150, PiecePressure: 125,
      Outposts: 125, Space: 100, KnightLikesClosed: 8,
      KeepKnight: 4, KeepQueen: 5,
      DoubledPawnMg: -12, DoubledPawnEg: -24,
      IsolatedPawnMg: -10, IsolatedPawnEg: -10,
      BackwardPawnMg: -8, BackwardPawnEg: -10, BackwardOnOpenMg: -8,
      Contempt: 5,
      GuideBookFile: 'guide/strangler.bin'
    },
    
    swapper: {
      name: 'SwapperRT',
      author: '',
      description: 'likes exchanging pieces, tends to go for a draw',
      PawnStructure: 120, Contempt: -20,
      GuideBookFile: 'guide.bin'
    }
  };
  
  // Playing style modifiers - partial updates to apply on top of current values
  const STYLES = {
    attacker: { name: 'Attacker', OwnAttack: 125, OppAttack: 100, OwnMobility: 75, OppMobility: 50 },
    defender: { name: 'Defender', OwnAttack: 100, OppAttack: 125, OwnMobility: 50, OppMobility: 75 },
    constrictor: { name: 'Constrictor', OwnAttack: 125, OppAttack: 100, OwnMobility: 50, OppMobility: 75 },
    escapist: { name: 'Escapist', OwnAttack: 100, OppAttack: 125, OwnMobility: 75, OppMobility: 50 }
  };
  
  // Get all field IDs from schema
  function getAllFieldIds() {
    const ids = [];
    for (const section of Object.values(FIELD_SCHEMA)) {
      if (Array.isArray(section)) {
        section.forEach(f => ids.push(f.id));
      } else {
        for (const group of Object.values(section)) {
          group.forEach(f => ids.push(f.id));
        }
      }
    }
    return ids;
  }
  
  // Get default values from schema
  function getDefaults() {
    const defaults = {};
    for (const section of Object.values(FIELD_SCHEMA)) {
      if (Array.isArray(section)) {
        section.forEach(f => { defaults[f.id] = f.default; });
      } else {
        for (const group of Object.values(section)) {
          group.forEach(f => { defaults[f.id] = f.default; });
        }
      }
    }
    return defaults;
  }
  
  // Apply values to form
  function applyToForm(values) {
    for (const [id, value] of Object.entries(values)) {
      const el = document.getElementById(id);
      if (el) {
        el.value = value;
      }
    }
  }
  
  // Get current form values
  function getFormValues() {
    const values = {};
    for (const id of getAllFieldIds()) {
      const el = document.getElementById(id);
      if (el) {
        values[id] = el.value;
      }
    }
    return values;
  }
  
  // Load a preset
  function loadPreset(presetName) {
    const defaults = getDefaults();
    const preset = PRESETS[presetName] || {};
    
    // Start with defaults, then apply preset overrides
    const values = { ...defaults };
    
    // Apply preset values (excluding metadata like name/description)
    for (const [key, value] of Object.entries(preset)) {
      if (key !== 'name' && key !== 'description' && key !== 'author') {
        values[key] = value;
      }
    }
    
    // Apply identity fields
    values.CharacterName = preset.name || 'RodentIVTuner';
    values.Author = preset.author || 'RodentIVTuner';
    values.Converter = 'RodentIVTuner';
    values.Description = preset.description || 'aggressive Pawn mover';
    
    applyToForm(values);
  }
  
  // Apply a playing style modifier
  function applyStyle(styleName) {
    const style = STYLES[styleName];
    if (!style) return;
    
    for (const [key, value] of Object.entries(style)) {
      if (key !== 'name') {
        const el = document.getElementById(key);
        if (el) el.value = value;
      }
    }
  }
  
  // Generate form HTML for a section
  function generateFormSection(sectionId) {
    const schema = FIELD_SCHEMA[sectionId];
    if (!schema) return '';
    
    let html = '';
    
    for (const [groupName, fields] of Object.entries(schema)) {
      html += `<div class="settings-group"><h3 class="settings-group-title">${groupName}</h3>`;
      
      for (const field of fields) {
        const helpHtml = field.help ? `<div class="settings-row-help">${field.help}</div>` : '';
        let inputHtml;
        
        if (field.type === 'select') {
          const options = field.options.map(opt => 
            `<option value="${opt}"${opt === field.default ? ' selected' : ''}>${opt}</option>`
          ).join('');
          inputHtml = `<div class="select"><select id="${field.id}">${options}</select></div>`;
        } else if (field.type === 'text') {
          inputHtml = `<input class="input" type="text" id="${field.id}" value="${field.default}">`;
        } else {
          inputHtml = `<input class="input" type="number" id="${field.id}" value="${field.default}" min="${field.min}" max="${field.max}">`;
        }
        
        html += `
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">${field.label}</div>
              ${helpHtml}
            </div>
            <div class="settings-row-control">${inputHtml}</div>
          </div>`;
      }
      
      html += '</div>';
    }
    
    return html;
  }
  
  // Generate preset buttons
  function generatePresetButtons() {
    const container = document.getElementById('preset-buttons');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (const [key, preset] of Object.entries(PRESETS)) {
      if (key === 'default') continue;
      
      const btn = document.createElement('button');
      btn.className = 'button is-primary';
      btn.textContent = preset.name;
      btn.title = preset.description || '';
      btn.onclick = () => loadPreset(key);
      container.appendChild(btn);
    }
  }
  
  // Generate style buttons
  function generateStyleButtons() {
    const container = document.getElementById('style-buttons');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (const [key, style] of Object.entries(STYLES)) {
      const btn = document.createElement('button');
      btn.className = 'button is-info is-outlined';
      btn.textContent = style.name;
      btn.onclick = () => applyStyle(key);
      container.appendChild(btn);
    }
  }
  
  // Export as Rodent personality file
  function exportPersonality() {
    const values = getFormValues();
    const lines = [
      '; Personality for Rodent IV chess engine',
      '; ',
      `; Name = ${values.CharacterName}`,
      '; personality for Rodent IV chess engine',
      `; author: ${values.Author}`,
      `; converted by: ${values.Converter}`,
      `; ${values.Description}`,
      ';'
    ];
    
    // Add all UCI options
    const uciFields = getAllFieldIds().filter(id => 
      !['CharacterName', 'Author', 'Converter', 'Description', 'GuideBookFile', 'MainBookFile'].includes(id)
    );
    
    for (const id of uciFields) {
      if (id === 'PrimaryPstStyle' || id === 'SecondaryPstStyle') {
        const numValue = PST_STYLES[values[id]] ?? 0;
        lines.push(`setoption name ${id} value ${numValue}`);
      } else {
        lines.push(`setoption name ${id} value ${values[id]}`);
      }
    }
    
    // Add book files
    lines.push(`setoption name GuideBookFile value ${values.GuideBookFile}`);
    lines.push(`setoption name MainBookFile value ${values.MainBookFile}`);
    
    downloadFile(`${values.CharacterName}.txt`, lines.join('\r\n'));
  }
  
  // Export as UCI config
  function exportUCI() {
    const values = getFormValues();
    const lines = [
      '[DEFAULT]',
      'Hash = 16',
      'Threads = 2',
      'UCI_LimitStrength = true',
      'UCI_Elo = 1800',
      '',
      `[${values.CharacterName}]`,
      `; ${values.CharacterName} personality for Rodent IV chess engine`,
      `; author: ${values.Author}`,
      `; ${values.Description}`,
      '; '
    ];
    
    // Add all UCI options
    const uciFields = getAllFieldIds().filter(id => 
      !['CharacterName', 'Author', 'Converter', 'Description', 'GuideBookFile', 'MainBookFile'].includes(id)
    );
    
    for (const id of uciFields) {
      if (id === 'PrimaryPstStyle' || id === 'SecondaryPstStyle') {
        const numValue = PST_STYLES[values[id]] ?? 0;
        lines.push(`${id} = ${numValue}`);
      } else {
        lines.push(`${id} = ${values[id]}`);
      }
    }
    
    // Add book files
    lines.push(`GuideBookFile = ${values.GuideBookFile}`);
    lines.push(`MainBookFile = ${values.MainBookFile}`);
    
    downloadFile('rodentIV.uci', lines.join('\n'));
  }
  
  // Download a file
  function downloadFile(filename, content) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  
  // Initialize
  function init() {
    // Generate form sections
    for (const sectionId of ['weights', 'piecevalues', 'pawnstructure', 'material', 'patterns']) {
      const container = document.getElementById(`${sectionId}-form`);
      if (container) {
        container.innerHTML = generateFormSection(sectionId);
      }
    }
    
    // Generate buttons
    generatePresetButtons();
    generateStyleButtons();
    
    // File upload display
    const fileInput = document.getElementById('file-upload');
    if (fileInput) {
      fileInput.onchange = function() {
        const fileName = document.getElementById('file-name');
        if (fileName && this.files.length > 0) {
          fileName.textContent = this.files[0].name;
        }
      };
    }
  }
  
  // Public API
  return {
    init,
    loadPreset,
    applyStyle,
    exportPersonality,
    exportUCI
  };
})();

// Section navigation
function showSection(sectionId) {
  document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
  document.getElementById('section-' + sectionId).classList.add('active');
  document.querySelector('[data-section="' + sectionId + '"]').classList.add('active');
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', RodentTuner.init);
</script>

{% endblock %}
