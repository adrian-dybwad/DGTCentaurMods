{% extends "base.html" %}

{% block mainpage %}

<div class="columns">
  <div class="column is-8">
    {% include "liveboard.html" %}
  </div>
  <div class="column is-4">
    <div class="box">
      <h3 class="title is-5" style="color: var(--color-accent-secondary);">Current Game</h3>
      <div id="current-game-info">
        <p class="has-text-grey">Waiting for game...</p>
      </div>
      <a href="/pgn" class="button is-primary is-small" style="margin-top: 1rem;">View All Games</a>
    </div>
    
    <div class="box" style="margin-top: 1rem;">
      <h3 class="title is-5" style="color: var(--color-accent-secondary);">Current PGN</h3>
      <textarea id="lastpgn" class="textarea" placeholder="PGN will appear here during play..." rows="8" readonly></textarea>
    </div>
  </div>
</div>

<script>
  // Update current game info from SSE game state updates
  function updateCurrentGameInfo(state) {
    const container = document.getElementById('current-game-info');
    if (!state || !state.fen) {
      container.innerHTML = '<p class="has-text-grey">Waiting for game...</p>';
      return;
    }
    
    const white = state.white || 'White';
    const black = state.black || 'Black';
    const turn = state.turn === 'w' ? 'White' : 'Black';
    const moveNum = state.move_number || 1;
    const result = state.result || '';
    const gameOver = state.game_over || false;
    
    let statusText = '';
    if (gameOver && result) {
      statusText = `<span class="tag is-info">${result}</span>`;
    } else {
      statusText = `<span class="tag is-light">Move ${moveNum} - ${turn} to play</span>`;
    }
    
    container.innerHTML = `
      <div style="padding: 0.5rem 0;">
        <div style="margin-bottom: 0.5rem;">
          <strong>${white}</strong> <span style="color: var(--color-text-muted);">(W)</span>
          vs
          <strong>${black}</strong> <span style="color: var(--color-text-muted);">(B)</span>
        </div>
        ${statusText}
      </div>
    `;
  }
  
  // Listen for game state updates from SSE (dispatched by liveboard.html)
  window.addEventListener('gameStateUpdate', function(event) {
    updateCurrentGameInfo(event.detail);
  });
  
  // Initial state - will be updated when SSE connects
  updateCurrentGameInfo(null);
</script>

{% endblock %}
