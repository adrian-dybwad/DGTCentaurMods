{% extends "base.html" %}

{% block mainpage %}

<script type="text/javascript" src="{{ url_for('static', filename='stockfish/stockfish.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="{{ url_for('static', filename='js/chess.js') }}"></script>
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>

<div class="columns">
  <div class="column is-8">
    {% include "liveboard.html" %}
  </div>
  <div class="column is-4">
    <div class="box">
      <h3 class="title is-5" style="color: var(--color-accent-secondary);">Current Game</h3>
      <div id="current-game-info">
        <p class="has-text-grey">Waiting for game...</p>
      </div>
    </div>
    
    <div class="box" style="margin-top: 1rem;">
      <h3 class="title is-5" style="color: var(--color-accent-secondary);">Analysis</h3>
      {% include "analysis_component.html" %}
    </div>
    
    <div class="box" style="margin-top: 1rem;">
      <h3 class="title is-5" style="color: var(--color-accent-secondary);">Current PGN</h3>
      <textarea id="lastpgn" class="textarea" placeholder="PGN will appear here during play..." rows="8" readonly></textarea>
    </div>
    
    <a href="/pgn" class="button is-primary is-small" style="margin-top: 1rem;">View All Games</a>
  </div>
</div>

<script>
  // State tracking for current game display
  // Note: lastGameState is declared in liveboard.html which is included above
  let lastDisplayedMoveNumber = 0;
  
  // Initialize analysis engine in live mode
  window.addEventListener('load', function() {
    analysisEngine.init({
      mode: 'live',
      containerId: 'analysis',
      stockfishPath: "{{ url_for('static', filename='stockfish/stockfish.js') }}",
      onPositionChange: function(fen, moveNumber) {
        // Update the board when navigating through moves
        if (typeof board1 !== 'undefined' && fen) {
          board1.position(fen);
        }
      }
    });
  });
  
  // Update current game info from SSE game state updates
  function updateCurrentGameInfo(state) {
    const container = document.getElementById('current-game-info');
    if (!state || !state.fen) {
      if (container) {
        container.innerHTML = '<p class="has-text-grey">Waiting for game...</p>';
      }
      return;
    }
    
    lastGameState = state;
    
    const white = state.white || 'White';
    const black = state.black || 'Black';
    const turn = state.turn === 'w' ? 'White' : 'Black';
    const moveNum = state.move_number || 1;
    const result = state.result || '';
    const gameOver = state.game_over || false;
    
    // Detect new game (move number reset)
    if (moveNum === 1 && lastDisplayedMoveNumber > 1) {
      lastDisplayedMoveNumber = 0;
    }
    
    lastDisplayedMoveNumber = moveNum;
    
    let statusText = '';
    if (gameOver && result) {
      statusText = `<span class="tag is-info">${result}</span>`;
    } else {
      statusText = `<span class="tag is-light">Move ${moveNum} - ${turn} to play</span>`;
    }
    
    if (container) {
      container.innerHTML = `
        <div style="padding: 0.5rem 0;">
          <div style="margin-bottom: 0.5rem;">
            <strong>${white}</strong> <span style="color: var(--color-text-muted);">(W)</span>
            vs
            <strong>${black}</strong> <span style="color: var(--color-text-muted);">(B)</span>
          </div>
          ${statusText}
        </div>
      `;
    }
    
    // analysisEngine listens to the same `gameStateUpdate` event internally in live mode.
  }
  
  // Listen for game state updates from SSE (dispatched by liveboard.html)
  window.addEventListener('gameStateUpdate', function(event) {
    updateCurrentGameInfo(event.detail);
  });
  
  // Listen for analysis position changes to sync board
  window.addEventListener('analysisPositionChange', function(event) {
    // Board already updated via onPositionChange callback
  });
  
  // Initial state - will be updated when SSE connects
  updateCurrentGameInfo(null);
</script>

{% endblock %}
