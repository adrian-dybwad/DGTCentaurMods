{% extends "base.html" %}

{% block mainpage %}

<div class="columns">
  <div class="column is-8">
    {% include "liveboard.html" %}
  </div>
  <div class="column is-4">
    <div class="box">
      <h3 class="title is-5" style="color: var(--color-accent-secondary);">Recent Games</h3>
      <div id="recent-games-list">
        <p class="has-text-grey">Loading...</p>
      </div>
      <a href="/pgn" class="button is-primary is-small" style="margin-top: 1rem;">View All Games</a>
    </div>
    
    <div class="box" style="margin-top: 1rem;">
      <h3 class="title is-5" style="color: var(--color-accent-secondary);">Current PGN</h3>
      <textarea id="lastpgn" class="textarea" placeholder="PGN will appear here during play..." rows="8" readonly></textarea>
    </div>
  </div>
</div>

<script>
  function loadRecentGames() {
    fetch('/getgames/1')
      .then(response => response.json())
      .then(games => {
        const container = document.getElementById('recent-games-list');
        if (Object.keys(games).length === 0) {
          container.innerHTML = '<p class="has-text-grey">No games yet</p>';
          return;
        }
        
        let html = '';
        let count = 0;
        for (let key in games) {
          if (count >= 5) break;
          const game = games[key];
          const white = game.white || 'White';
          const black = game.black || 'Black';
          const result = game.result && game.result !== 'None' ? game.result : '';
          const date = game.created_at && game.created_at !== 'None' 
            ? new Date(game.created_at).toLocaleDateString() 
            : '';
          
          html += `
            <a href="/analyse/${game.id}" class="panel-block" style="padding: 0.5rem 0; border: none;">
              <span style="flex: 1;">
                <strong>${white}</strong> vs <strong>${black}</strong>
                ${result ? '<span class="tag is-small" style="margin-left: 0.5rem;">' + result + '</span>' : ''}
              </span>
              <span class="has-text-grey is-size-7">${date}</span>
            </a>
          `;
          count++;
        }
        container.innerHTML = html;
      })
      .catch(err => {
        document.getElementById('recent-games-list').innerHTML = '<p class="has-text-danger">Failed to load</p>';
      });
  }
  
  loadRecentGames();
  setInterval(loadRecentGames, 30000);
</script>

{% endblock %}
