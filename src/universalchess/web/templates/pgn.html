{% extends "base.html" %}

{% block mainpage %}

<div style="width:100%">
    <div class="level">
        <div class="level-left">
            <h2 class="title" style="color: var(--color-accent-primary);">Game History</h2>
        </div>
        <div class="level-right">
            <div class="buttons">
                <button class="button is-small" id="prevPage" onclick="prevPage()" disabled>Previous</button>
                <span id="pageIndicator" style="padding: 0 1rem; color: var(--color-text-secondary);">Page 1</span>
                <button class="button is-small" id="nextPage" onclick="nextPage()">Next</button>
            </div>
        </div>
    </div>
    
    <div id="gameslisting">
        <div class="has-text-centered" style="padding: 3rem;">
            <p style="color: var(--color-text-muted);">Loading games...</p>
        </div>
    </div>
</div>

<script>
    var page = 1;
    var totalGames = 0;
    
    function showPGN(gameid) {
        var pgnDiv = document.getElementById("gamepgn-" + gameid);
        if (pgnDiv.innerHTML.trim() !== '') {
            pgnDiv.style.display = pgnDiv.style.display === 'none' ? 'block' : 'none';
            return;
        }
        
        pgnDiv.innerHTML = '<span style="color: var(--color-text-muted);">Loading...</span>';
        
        fetch('/getpgn/' + gameid)
            .then(response => response.text())
            .then(pgn => {
                pgnDiv.innerHTML = '<pre style="background: var(--color-bg-secondary); padding: 1rem; border-radius: 0.5rem; font-size: 0.85rem; max-height: 300px; overflow: auto; white-space: pre-wrap;">' + pgn + '</pre>';
            });
    }
    
    function deletePGN(gameid) {
        if (!confirm('Delete this game? This cannot be undone.')) return;
        fetch('/deletegame/' + gameid)
            .then(() => getGamesPGNList());
    }
    
    function prevPage() {
        if (page > 1) {
            page--;
            getGamesPGNList();
            updatePageControls();
        }
    }
    
    function nextPage() {
        page++;
        getGamesPGNList();
        updatePageControls();
    }
    
    function updatePageControls() {
        document.getElementById('pageIndicator').textContent = 'Page ' + page;
        document.getElementById('prevPage').disabled = page <= 1;
    }
    
    function getGamesPGNList() {
        fetch('/getgames/' + page)
            .then(response => response.json())
            .then(games => {
                const container = document.getElementById('gameslisting');
                
                if (Object.keys(games).length === 0) {
                    if (page > 1) {
                        page--;
                        updatePageControls();
                    }
                    container.innerHTML = '<div class="has-text-centered" style="padding: 3rem; color: var(--color-text-muted);">No more games</div>';
                    return;
                }
                
                let html = '';
                for (let key in games) {
                    const game = games[key];
                    const white = game.white && game.white !== 'None' ? game.white : 'Player';
                    const black = game.black && game.black !== 'None' ? game.black : 'Player';
                    const result = game.result && game.result !== 'None' ? game.result : '';
                    const date = game.created_at && game.created_at !== 'None' 
                        ? new Date(game.created_at).toLocaleDateString() 
                        : '';
                    const source = game.source && game.source !== 'None' ? game.source : '';
                    
                    html += `
                        <div class="game-card" id="gamecard-${game.id}">
                            <div class="game-card-header">
                                <div class="game-players">
                                    <strong>${white}</strong> <span style="color: var(--color-text-muted);">(W)</span>
                                    <span class="vs">vs</span>
                                    <strong>${black}</strong> <span style="color: var(--color-text-muted);">(B)</span>
                                </div>
                                ${result ? '<span class="game-result">' + result + '</span>' : ''}
                            </div>
                            <div class="game-meta">
                                ${date ? '<span>' + date + '</span>' : ''}
                                ${source ? '<span>' + source + '</span>' : ''}
                            </div>
                            <div id="gamepgn-${game.id}" style="display: none; margin-top: 1rem;"></div>
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="button is-small is-light" onclick="showPGN(${game.id})">Show PGN</button>
                                <a href="/analyse/${game.id}" class="button is-small is-primary">Analyse</a>
                                <button class="button is-small is-danger is-outlined" onclick="deletePGN(${game.id})">Delete</button>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            })
            .catch(err => {
                document.getElementById('gameslisting').innerHTML = '<div class="has-text-centered has-text-danger" style="padding: 3rem;">Failed to load games</div>';
            });
    }
    
    function hideLastPGN() { /* compatibility */ }
    function showLastGames() { /* compatibility */ }

    window.onload = function () {
        getGamesPGNList();
    }
</script>

{% endblock %}
