<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Universal Chess - Connect, play, and analyze chess on your smart chess board">
    <meta name="theme-color" content="#aa44aa">
    
    <!-- PWA Support -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json', v=static_version) }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon.svg', v=static_version) }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <title>Universal Chess</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='chessboardjs/css/chessboard-1.0.0.css', v=static_version) }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css', v=static_version) }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='icons/icon.svg', v=static_version) }}">
  </head>
  <body>
  <!--
    This file is part of the Universal Chess open source software
    https://github.com/adrian-dybwad/Universal-Chess
    
    Based on DGTCentaur Mods (https://github.com/EdNekebno/DGTCentaur)
    
    Universal Chess is free software: you can redistribute
    it and/or modify it under the terms of the GNU General Public
    License as published by the Free Software Foundation, either
    version 3 of the License, or (at your option) any later version.
    
    Universal Chess is distributed in the hope that it will
    be useful, but WITHOUT ANY WARRANTY; without even the implied warranty
    of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    GNU General Public License for more details.
    
    You should have received a copy of the GNU General Public License
    along with this file. If not, see https://www.gnu.org/licenses/
    
    This and any other notices must remain intact and unaltered in any
    distribution, modification, variant, or derivative of this software.
  -->
  
  {% include 'navbar.html' %}

  <section class="section">
    <div class="container">
      {% block mainpage %}{% endblock %}
    </div>
  </section>
  
  <footer class="footer">
    <div class="content has-text-centered">
      <p>
        <strong>Universal Chess</strong> &mdash; Open source software for smart chess boards
        <br>
        <a href="https://github.com/adrian-dybwad/Universal-Chess" target="_blank" rel="noopener">GitHub</a>
        &bull;
        <a href="/license">License</a>
        &bull;
        <a href="/support">Support</a>
      </p>
    </div>
  </footer>
  
  <!-- PWA Install Prompt -->
  <div class="pwa-install-prompt" id="pwaInstallPrompt">
    <span>Install Universal Chess for quick access</span>
    <button class="button is-primary is-small" id="pwaInstallBtn">Install</button>
    <button class="button is-light is-small" id="pwaInstallDismiss">Not now</button>
  </div>
  
  <script>
    // Connection status is now driven by the SSE client (game_client.js) on pages that use it.
    // Avoid polling /fen from every page, which created multiple paths and unnecessary load.
    // PWA Install
    let deferredPrompt;
    const pwaPrompt = document.getElementById('pwaInstallPrompt');
    const pwaInstallBtn = document.getElementById('pwaInstallBtn');
    const pwaDismissBtn = document.getElementById('pwaInstallDismiss');
    
    if (pwaPrompt && pwaInstallBtn && pwaDismissBtn) {
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        pwaPrompt.classList.add('show');
      });
      
      pwaInstallBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          pwaPrompt.classList.remove('show');
        }
      });
      
      pwaDismissBtn.addEventListener('click', () => {
        pwaPrompt.classList.remove('show');
      });
    }
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register("{{ url_for('static', filename='sw.js', v=static_version) }}")
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>

  <!-- Core JS dependencies (loaded once to avoid duplicate execution across templates) -->
  <script src="{{ url_for('static', filename='js/jquery-3.4.1.min.js', v=static_version) }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='chessboardjs/js/chessboard-1.0.0.min.js', v=static_version) }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/domarrow.js', v=static_version) }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/board.js', v=static_version) }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/game_client.js', v=static_version) }}"></script>

  </body>
</html>
