{% extends "base.html" %}

{% block mainpage %}

<div style="width:100%">
    <div id="settings">
        
        {% if centaur_software_installed %}
        <!-- Original Centaur Software Section - Only shown if installed -->
        <article class="panel is-info">
            <p class="panel-heading">
                Original Centaur Software
            </p>
            <div class="panel-block">
                <div class="content" style="width: 100%;">
                    <p>The original DGT Centaur software is installed on this device. You can switch back to it if needed.</p>
                    <button class="button is-warning" id="return2DGTMods" onclick="returnToOriginalCentaur()">
                        Switch to Original Centaur
                    </button>
                </div>
            </div>
        </article>
        {% endif %}
        
        <!-- Lichess Integration -->
        <article class="panel is-info">
            <p class="panel-heading">
                Lichess Integration
            </p>
            <div class="panel-block">
                <div class="content">
                    <p>Connect to <a href="https://lichess.org" target="_blank" rel="noopener">Lichess</a> to play online games directly from your board.</p>
                </div>
            </div>
            <div class="panel-block">
                <div class="field" style="width: 100%;">
                    <label class="label">API Token</label>
                    <div class="control">
                        <input class="input" id="lichesskey" type="password" 
                               placeholder="Enter Lichess API token" 
                               value="{{ lichesskey }}" 
                               onkeydown="markLichessChanged()">
                    </div>
                    <p class="help">
                        <a href="https://lichess.org/account/oauth/token" target="_blank" rel="noopener">Get a token</a> 
                        with <code>challenge:write</code> and <code>board:play</code> permissions.
                    </p>
                </div>
            </div>
            <div class="panel-block">
                <div class="field" style="width: 100%;">
                    <label class="label">Rating Range (optional)</label>
                    <div class="control">
                        <input class="input" id="lichessrange" type="text" 
                               placeholder="e.g., 1000-1400" 
                               value="{{ lichessrange }}"
                               onkeydown="markLichessChanged()">
                    </div>
                    <p class="help">Preferred opponent rating range for matchmaking.</p>
                </div>
            </div>
            <div class="panel-block">
                <div class="is-pulled-right" style="width:100%">
                    <button class="button is-info is-pulled-right" id="lichesssavebutton" onclick="saveLichess()">
                        Save Lichess Settings
                    </button>
                </div>
            </div>
        </article>
        
        <!-- Engine Management -->
        <article class="panel is-info">
            <p class="panel-heading">
                Custom Engines
            </p>
            <div class="panel-block">
                <div class="content">
                    <p>Upload custom UCI chess engines and configuration files. Engines must be compiled for ARM architecture.</p>
                </div>
            </div>
            <div id="filelisting"></div>
            <div class="panel-block">
                <form method="POST" action="/uploadengine" enctype="multipart/form-data" style="width: 100%;">
                    <div class="file has-name is-fullwidth" id="file-upload-wrapper">
                        <label class="file-label" style="width: 100%;">
                            <input class="file-input" type="file" name="file" id="engine-file-input">
                            <span class="file-cta">
                                <span class="file-icon">&#128193;</span>
                                <span class="file-label">Choose file...</span>
                            </span>
                            <span class="file-name" id="engine-file-name">No file selected</span>
                        </label>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="button is-info" type="submit">Upload Engine</button>
                    </div>
                </form>
            </div>
        </article>
        
        <!-- Menu Options -->
        <article class="panel is-info">
            <p class="panel-heading">
                Main Menu Options
            </p>
            <div class="panel-block">
                <div class="content">
                    <p>Enable or disable options in the board's main menu. Changes take effect after restart.</p>
                </div>
            </div>
            <div class="panel-block">
                <div class="settings-group" style="width: 100%;">
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" name="Engines" id="Engines" {{ menuEngines }}>
                            Engines
                        </label>
                        <span class="settings-description">Play against installed chess engines</span>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" name="HandBrain" id="HandBrain" {{ menuHandBrain }}>
                            Hand + Brain
                        </label>
                        <span class="settings-description">Engine suggests piece type, you choose the move</span>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" name="1v1Analysis" id="1v1Analysis" {{ menu1v1Analysis }}>
                            1v1 Analysis
                        </label>
                        <span class="settings-description">Play with real-time position analysis</span>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" name="EmulateEB" id="EmulateEB" {{ menuEmulateEB }}>
                            e-Board Mode
                        </label>
                        <span class="settings-description">Use as an input device for chess software</span>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" name="Cast" id="Cast" {{ menuCast }}>
                            Chromecast
                        </label>
                        <span class="settings-description">Stream the board display to a TV</span>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" name="msettings" id="msettings" {{ menuSettings }}>
                            Settings
                        </label>
                        <span class="settings-description">Access display and system settings</span>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" name="About" id="About" {{ menuAbout }}>
                            About
                        </label>
                        <span class="settings-description">Version info and support links</span>
                    </div>
                </div>
            </div>
            <div class="panel-block">
                <div class="is-pulled-right" style="width:100%">
                    <button class="button is-info is-pulled-right" id="menusavebutton" onclick="saveMenu()">
                        Save Menu Options
                    </button>
                </div>
            </div>
        </article>
        
    </div>
</div>

<script>
    window.onload = function () {
        hideLastPGN();
        hideLastGames();
        getEngineFiles();
        
        // File input display
        var fileInput = document.getElementById('engine-file-input');
        if (fileInput) {
            fileInput.onchange = function() {
                var fileName = document.getElementById('engine-file-name');
                if (fileInput.files.length > 0) {
                    fileName.textContent = fileInput.files[0].name;
                } else {
                    fileName.textContent = 'No file selected';
                }
            };
        }
    };
    
    function markLichessChanged() {
        document.getElementById('lichesssavebutton').classList.add('is-warning');
        document.getElementById('lichesssavebutton').classList.remove('is-info');
    }
    
    {% if centaur_software_installed %}
    function returnToOriginalCentaur() {
        if (!confirm('Switch to the original Centaur software? Universal Chess will stop running.')) {
            return;
        }
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", "/return2dgtcentaurmods", true);
        xmlhttp.send();
    }
    {% endif %}

    function saveLichess() {
        var newkey = document.getElementById("lichesskey").value;
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                if (xmlhttp.responseText == "ok") {
                    var newrange = document.getElementById("lichessrange").value;
                    var xmlhttp2 = new XMLHttpRequest();
                    xmlhttp2.onreadystatechange = function() {
                        if (xmlhttp2.readyState == 4 && xmlhttp2.status == 200) {
                            if (xmlhttp2.responseText == "ok") {
                                var btn = document.getElementById('lichesssavebutton');
                                btn.classList.remove('is-warning');
                                btn.classList.add('is-success');
                                btn.textContent = 'Saved!';
                                setTimeout(function() {
                                    btn.classList.remove('is-success');
                                    btn.classList.add('is-info');
                                    btn.textContent = 'Save Lichess Settings';
                                }, 2000);
                            }
                        }
                    };
                    xmlhttp2.open("GET", "/lichessrange/" + encodeURIComponent(newrange), true);
                    xmlhttp2.send();
                }
            }
        };
        xmlhttp.open("GET", "/lichesskey/" + encodeURIComponent(newkey), true);
        xmlhttp.send();
    }

    function saveMenu() {
        var menuEngines = document.getElementById('Engines').checked;
        var menuHandBrain = document.getElementById('HandBrain').checked;
        var menu1v1Analysis = document.getElementById('1v1Analysis').checked;
        var menuEmulateEB = document.getElementById('EmulateEB').checked;
        var menuCast = document.getElementById('Cast').checked;
        var menuSettings = document.getElementById('msettings').checked;
        var menuAbout = document.getElementById('About').checked;
        
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                if (xmlhttp.responseText == "ok") {
                    var btn = document.getElementById('menusavebutton');
                    btn.classList.add('is-success');
                    btn.textContent = 'Saved! Restart to apply.';
                    setTimeout(function() {
                        btn.classList.remove('is-success');
                        btn.textContent = 'Save Menu Options';
                    }, 3000);
                }
            }
        };
        var url = "/menuoptions/" + menuEngines + "/" + menuHandBrain + "/" + menu1v1Analysis + "/" + 
                  menuEmulateEB + "/" + menuCast + "/" + menuSettings + "/" + menuAbout;
        xmlhttp.open("GET", url, true);
        xmlhttp.send();
        return false;
    }

    function getEngineFiles() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                var obj = JSON.parse(xmlhttp.responseText);
                var fl = document.getElementById('filelisting');
                fl.innerHTML = '';
                
                if (obj.length === 0) {
                    var emptyMsg = document.createElement("div");
                    emptyMsg.className = "panel-block";
                    emptyMsg.innerHTML = '<span style="color: var(--color-text-muted);">No custom engines installed</span>';
                    fl.appendChild(emptyMsg);
                    return;
                }
                
                for (var x = 0; x < obj.length; x++) {
                    var pb = document.createElement("div");
                    pb.className = "panel-block";
                    pb.style.justifyContent = "space-between";
                    
                    var nameSpan = document.createElement("span");
                    nameSpan.textContent = obj[x];
                    pb.appendChild(nameSpan);
                    
                    var deleteBtn = document.createElement("button");
                    deleteBtn.className = "button is-small is-danger is-outlined";
                    deleteBtn.textContent = "Remove";
                    deleteBtn.onclick = (function(name) {
                        return function() { delengine(name); };
                    })(obj[x]);
                    pb.appendChild(deleteBtn);
                    
                    fl.appendChild(pb);
                }
            }
        };
        xmlhttp.open("GET", "/engines", true);
        xmlhttp.send();
    }

    function delengine(name) {
        if (!confirm('Remove engine "' + name + '"?')) return;
        
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                getEngineFiles();
            }
        };
        xmlhttp.open("GET", "/delengine/" + encodeURIComponent(name), true);
        xmlhttp.send();
    }
</script>

{% endblock %}
