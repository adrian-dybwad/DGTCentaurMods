{% extends "base.html" %}

{% block mainpage %}

<div class="settings-container">
  <!-- Sidebar Navigation -->
  <div class="settings-sidebar">
    <nav class="settings-nav">
      <a class="settings-nav-item active" data-section="players" onclick="showSection('players')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        </span>
        <span>Players</span>
      </a>
      <a class="settings-nav-item" data-section="game" onclick="showSection('game')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
        </span>
        <span>Game</span>
      </a>
      <a class="settings-nav-item" data-section="display" onclick="showSection('display')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/></svg>
        </span>
        <span>Display</span>
      </a>
      <a class="settings-nav-item" data-section="lichess" onclick="showSection('lichess')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        </span>
        <span>Lichess</span>
      </a>
      <a class="settings-nav-item" data-section="engines" onclick="showSection('engines')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </span>
        <span>Engines</span>
      </a>
      <a class="settings-nav-item" data-section="sound" onclick="showSection('sound')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        </span>
        <span>Sound</span>
      </a>
      <a class="settings-nav-item" data-section="system" onclick="showSection('system')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 11c.34 0 .67.04 1 .09V6.27L10.5 3 3 6.27v4.91c0 4.54 3.2 8.79 7.5 9.82.55-.13 1.08-.32 1.6-.55-.69-.98-1.1-2.17-1.1-3.45 0-3.31 2.69-6 6-6z"/><path d="M17 13c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 1.38c.62 0 1.12.51 1.12 1.12s-.51 1.12-1.12 1.12-1.12-.51-1.12-1.12.5-1.12 1.12-1.12zm0 5.37c-.93 0-1.74-.46-2.24-1.17.05-.72 1.51-1.08 2.24-1.08s2.19.36 2.24 1.08c-.5.71-1.31 1.17-2.24 1.17z"/></svg>
        </span>
        <span>System</span>
      </a>
      {% if centaur_software_installed %}
      <a class="settings-nav-item" data-section="centaur" onclick="showSection('centaur')">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg>
        </span>
        <span>Original</span>
      </a>
      {% endif %}
    </nav>
  </div>
  
  <!-- Settings Content -->
  <div class="settings-content">
    
    <!-- PLAYERS SECTION -->
    <div id="section-players" class="settings-section active">
      <div class="settings-header">
        <h2 class="settings-title">Player Settings</h2>
        <p class="settings-description">Configure player names, types, and engine preferences</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <h3 class="settings-group-title">Player 1 (White by default)</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Player Type</div>
              <div class="settings-row-help">Human, Engine, Hand+Brain, or Lichess</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player1-type" onchange="markChanged(); updatePlayerTypeVisibility()">
                  <option value="human">Human</option>
                  <option value="engine">Engine</option>
                  <option value="hand_brain">Hand+Brain</option>
                  <option value="lichess">Lichess</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Player Name</div>
              <div class="settings-row-help">Optional name for PGN headers</div>
            </div>
            <div class="settings-row-control">
              <input class="input" type="text" id="player1-name" placeholder="Player 1" onchange="markChanged()">
            </div>
          </div>
          
          <div class="settings-row" id="player1-engine-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Engine</div>
              <div class="settings-row-help">Chess engine to use</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player1-engine" onchange="markChanged()">
                  <option value="stockfish">Stockfish</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="settings-row" id="player1-elo-row">
            <div class="settings-row-info">
              <div class="settings-row-label">ELO Level</div>
              <div class="settings-row-help">Engine strength setting</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player1-elo" onchange="markChanged()">
                  <option value="Default">Default</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="settings-row" id="player1-hb-mode-row" style="display: none;">
            <div class="settings-row-info">
              <div class="settings-row-label">Hand+Brain Mode</div>
              <div class="settings-row-help">How the human and engine collaborate</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player1-hb-mode" onchange="markChanged()">
                  <option value="normal">Normal (Engine = Brain)</option>
                  <option value="reverse">Reverse (Human = Brain)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">Player 2 (Black by default)</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Player Type</div>
              <div class="settings-row-help">Human, Engine, Hand+Brain, or Lichess</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player2-type" onchange="markChanged(); updatePlayerTypeVisibility()">
                  <option value="human">Human</option>
                  <option value="engine">Engine</option>
                  <option value="hand_brain">Hand+Brain</option>
                  <option value="lichess">Lichess</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Player Name</div>
              <div class="settings-row-help">Optional name for PGN headers</div>
            </div>
            <div class="settings-row-control">
              <input class="input" type="text" id="player2-name" placeholder="Player 2" onchange="markChanged()">
            </div>
          </div>
          
          <div class="settings-row" id="player2-engine-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Engine</div>
              <div class="settings-row-help">Chess engine to use</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player2-engine" onchange="markChanged()">
                  <option value="stockfish">Stockfish</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="settings-row" id="player2-elo-row">
            <div class="settings-row-info">
              <div class="settings-row-label">ELO Level</div>
              <div class="settings-row-help">Engine strength setting</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player2-elo" onchange="markChanged()">
                  <option value="Default">Default</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="settings-row" id="player2-hb-mode-row" style="display: none;">
            <div class="settings-row-info">
              <div class="settings-row-label">Hand+Brain Mode</div>
              <div class="settings-row-help">How the human and engine collaborate</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="player2-hb-mode" onchange="markChanged()">
                  <option value="normal">Normal (Engine = Brain)</option>
                  <option value="reverse">Reverse (Human = Brain)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Hand+Brain Explanation Card -->
      <div class="settings-card" id="hand-brain-explanation" style="display: none;">
        <div class="settings-group">
          <h3 class="settings-group-title">What is Hand+Brain?</h3>
          <p style="color: var(--color-text-secondary); margin-bottom: 1rem;">
            Hand+Brain is a collaborative chess variant where a human and engine work together as a team.
            One partner is the "Brain" (chooses WHICH piece type to move) and the other is the "Hand" (chooses WHERE to move it).
          </p>
          
          <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
            <div style="background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-md); border-left: 4px solid var(--color-accent-primary);">
              <strong style="color: var(--color-accent-secondary);">Normal Mode</strong>
              <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                <strong>Engine = Brain:</strong> The engine analyzes and suggests a piece type (e.g., "Knight").<br>
                <strong>Human = Hand:</strong> You choose any legal move using that piece type.<br>
                <em>Great for learning strategy from the engine's piece selection.</em>
              </p>
            </div>
            <div style="background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-md); border-left: 4px solid var(--color-accent-highlight);">
              <strong style="color: var(--color-accent-secondary);">Reverse Mode</strong>
              <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                <strong>Human = Brain:</strong> You lift and replace a piece to select its type.<br>
                <strong>Engine = Hand:</strong> The engine finds the best move with that piece, shown via LEDs.<br>
                <em>Great for practicing piece coordination while engine handles tactics.</em>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GAME SECTION -->
    <div id="section-game" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Game Settings</h2>
        <p class="settings-description">Time controls and game behavior</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <h3 class="settings-group-title">Time Control</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Time per Player</div>
              <div class="settings-row-help">Minutes per player (0 = untimed)</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="game-time-control" onchange="markChanged()">
                  <option value="0">Untimed</option>
                  <option value="1">1 min (Bullet)</option>
                  <option value="3">3 min (Blitz)</option>
                  <option value="5">5 min (Blitz)</option>
                  <option value="10">10 min (Rapid)</option>
                  <option value="15">15 min (Rapid)</option>
                  <option value="30">30 min (Classical)</option>
                  <option value="60">60 min (Classical)</option>
                  <option value="90">90 min (Classical)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">Analysis</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Live Analysis</div>
              <div class="settings-row-help">Show engine evaluation during play</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="game-analysis-mode" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Analysis Engine</div>
              <div class="settings-row-help">Engine used for position analysis</div>
            </div>
            <div class="settings-row-control">
              <div class="select">
                <select id="game-analysis-engine" onchange="markChanged()">
                  <option value="stockfish">Stockfish</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- DISPLAY SECTION -->
    <div id="section-display" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Display Settings</h2>
        <p class="settings-description">Control what appears on the e-paper display and LEDs</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <h3 class="settings-group-title">E-Paper Display</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Show Board</div>
              <div class="settings-row-help">Display chess board on screen</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="display-show-board" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Show Clock</div>
              <div class="settings-row-help">Display game clock and turn indicator</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="display-show-clock" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Show Analysis</div>
              <div class="settings-row-help">Display engine analysis widget</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="display-show-analysis" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Show Evaluation Graph</div>
              <div class="settings-row-help">Display evaluation history graph</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="display-show-graph" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">LEDs</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">LED Brightness</div>
              <div class="settings-row-help">Brightness level (1-10)</div>
            </div>
            <div class="settings-row-control" style="display: flex; align-items: center; gap: 1rem;">
              <input type="range" class="range-slider" id="display-led-brightness" min="1" max="10" value="5" onchange="markChanged()">
              <span id="led-brightness-value">5</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- LICHESS SECTION -->
    <div id="section-lichess" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Lichess Integration</h2>
        <p class="settings-description">Connect to Lichess for online play</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <h3 class="settings-group-title">API Connection</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">API Token</div>
              <div class="settings-row-help">
                <a href="https://lichess.org/account/oauth/token" target="_blank" rel="noopener">Get a token</a> 
                with challenge:write and board:play permissions
              </div>
            </div>
            <div class="settings-row-control" style="width: 300px;">
              <input class="input" type="password" id="lichess-api-token" placeholder="lip_xxxxxxxx" onchange="markChanged()">
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Rating Range</div>
              <div class="settings-row-help">Preferred opponent rating range for matchmaking</div>
            </div>
            <div class="settings-row-control" style="width: 150px;">
              <input class="input" type="text" id="lichess-range" placeholder="1000-1600" onchange="markChanged()">
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ENGINES SECTION -->
    <div id="section-engines" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Chess Engines</h2>
        <p class="settings-description">Install and manage chess engines for play and analysis</p>
      </div>
      
      <!-- Install Queue Status -->
      <div id="engine-queue-status" class="settings-card" style="display: none;">
        <div class="settings-group">
          <h3 class="settings-group-title">Installation Progress</h3>
          <div id="engine-queue-list"></div>
        </div>
      </div>
      
      <!-- Engine List -->
      <div id="engines-list">
        <div class="has-text-centered" style="padding: 2rem;">
          <p class="has-text-grey">Loading engines...</p>
        </div>
      </div>
    </div>
    
    <!-- SOUND SECTION -->
    <div id="section-sound" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Sound Settings</h2>
        <p class="settings-description">Audio feedback configuration</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Sound Enabled</div>
              <div class="settings-row-help">Master switch for all sound effects</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="sound-enabled" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Key Press</div>
              <div class="settings-row-help">Beep when buttons are pressed</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="sound-key-press" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Game Events</div>
              <div class="settings-row-help">Beep for check, checkmate, and other game events</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="sound-game-event" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Piece Events</div>
              <div class="settings-row-help">Beep when pieces are lifted or placed</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="sound-piece-event" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Errors</div>
              <div class="settings-row-help">Beep on error conditions</div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="sound-error" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- SYSTEM SECTION -->
    <div id="section-system" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">System Settings</h2>
        <p class="settings-description">Advanced configuration for developers and power users</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <h3 class="settings-group-title">Developer Mode</h3>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Enable Developer Mode</div>
              <div class="settings-row-help">
                Enables verbose debug logging to the system journal. Useful for diagnosing issues 
                with board communication, engine behavior, or Bluetooth connectivity. 
                View logs with: <code style="background: var(--color-bg-tertiary); padding: 0.1rem 0.3rem; border-radius: 3px;">journalctl -u universal-chess -f</code>
              </div>
            </div>
            <div class="settings-row-control">
              <label class="toggle-switch">
                <input type="checkbox" id="system-developer" onchange="markChanged()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="settings-group">
          <h3 class="settings-group-title">Game Database</h3>
          <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
            Universal Chess stores all your games in a database. By default, it uses SQLite at 
            <code style="background: var(--color-bg-tertiary); padding: 0.1rem 0.3rem; border-radius: 3px;">/opt/universalchess/db/centaur.db</code>. 
            You can configure an external database for backup, sync, or multi-device setups.
          </p>
          
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Database URI</div>
              <div class="settings-row-help">
                Leave empty for default SQLite. Supports any SQLAlchemy-compatible URI.
              </div>
            </div>
            <div class="settings-row-control" style="width: 100%; max-width: 400px;">
              <input class="input" type="text" id="database-uri" placeholder="(default SQLite)" onchange="markChanged()">
            </div>
          </div>
          
          <div style="margin-top: 1rem; padding: 1rem; background: var(--color-bg-secondary); border-radius: var(--radius-md);">
            <strong style="color: var(--color-text-primary); font-size: 0.9rem;">Supported Database URIs:</strong>
            <ul style="color: var(--color-text-secondary); font-size: 0.85rem; margin: 0.5rem 0 0 1.5rem; padding: 0;">
              <li><code>sqlite:///path/to/games.db</code> - Local SQLite file</li>
              <li><code>postgresql://user:pass@host:5432/dbname</code> - PostgreSQL</li>
              <li><code>mysql://user:pass@host:3306/dbname</code> - MySQL/MariaDB</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    {% if centaur_software_installed %}
    <!-- ORIGINAL CENTAUR SECTION -->
    <div id="section-centaur" class="settings-section">
      <div class="settings-header">
        <h2 class="settings-title">Original Centaur Software</h2>
        <p class="settings-description">Switch to the original DGT Centaur software</p>
      </div>
      
      <div class="settings-card">
        <div class="settings-group">
          <p style="margin-bottom: 1rem;">The original DGT Centaur software is installed on this device. You can switch back to it if needed.</p>
          <button class="button is-warning" onclick="switchToOriginalCentaur()">
            Switch to Original Centaur
          </button>
        </div>
      </div>
    </div>
    {% endif %}
    
  </div>
</div>

<!-- Apply Settings Bar -->
<div class="apply-settings-bar" id="applySettingsBar">
  <span class="changes-count" id="changesCount">Unsaved changes</span>
  <button class="button is-light" onclick="discardChanges()">Discard</button>
  <button class="button is-primary" onclick="saveSettings()">Save Changes</button>
  <button class="button is-success" onclick="saveAndApply()">Save & Apply</button>
</div>

<script>
  let hasChanges = false;
  let originalSettings = {};
  
  // Section navigation
  function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.settings-nav-item').forEach(n => n.classList.remove('active'));
    
    // Show selected section
    document.getElementById('section-' + sectionId).classList.add('active');
    document.querySelector('[data-section="' + sectionId + '"]').classList.add('active');
  }
  
  // Show/hide fields based on player type
  function updatePlayerTypeVisibility() {
    const p1Type = document.getElementById('player1-type').value;
    const p2Type = document.getElementById('player2-type').value;
    
    // Player 1 visibility
    const p1ShowEngine = (p1Type === 'engine' || p1Type === 'hand_brain');
    document.getElementById('player1-engine-row').style.display = p1ShowEngine ? 'flex' : 'none';
    document.getElementById('player1-elo-row').style.display = p1ShowEngine ? 'flex' : 'none';
    document.getElementById('player1-hb-mode-row').style.display = (p1Type === 'hand_brain') ? 'flex' : 'none';
    
    // Player 2 visibility
    const p2ShowEngine = (p2Type === 'engine' || p2Type === 'hand_brain');
    document.getElementById('player2-engine-row').style.display = p2ShowEngine ? 'flex' : 'none';
    document.getElementById('player2-elo-row').style.display = p2ShowEngine ? 'flex' : 'none';
    document.getElementById('player2-hb-mode-row').style.display = (p2Type === 'hand_brain') ? 'flex' : 'none';
    
    // Show Hand+Brain explanation if either player is hand_brain
    const showHBExplanation = (p1Type === 'hand_brain' || p2Type === 'hand_brain');
    document.getElementById('hand-brain-explanation').style.display = showHBExplanation ? 'block' : 'none';
  }
  
  // Mark changes
  function markChanged() {
    hasChanges = true;
    document.getElementById('applySettingsBar').classList.add('show');
    
    // Update LED brightness display
    const ledSlider = document.getElementById('display-led-brightness');
    const ledValue = document.getElementById('led-brightness-value');
    if (ledSlider && ledValue) {
      ledValue.textContent = ledSlider.value;
    }
  }
  
  // Load all settings
  function loadSettings() {
    fetch('/api/settings')
      .then(response => response.json())
      .then(data => {
        originalSettings = data;
        applySettingsToForm(data);
      })
      .catch(err => console.error('Failed to load settings:', err));
  }
  
  function applySettingsToForm(data) {
    // Player 1
    if (data.PlayerOne) {
      setSelectValue('player1-type', data.PlayerOne.type || 'human');
      document.getElementById('player1-name').value = data.PlayerOne.name || '';
      setSelectValue('player1-engine', data.PlayerOne.engine || 'stockfish');
      setSelectValue('player1-elo', data.PlayerOne.elo || 'Default');
      setSelectValue('player1-hb-mode', data.PlayerOne.hand_brain_mode || 'normal');
    }
    
    // Player 2
    if (data.PlayerTwo) {
      setSelectValue('player2-type', data.PlayerTwo.type || 'engine');
      document.getElementById('player2-name').value = data.PlayerTwo.name || '';
      setSelectValue('player2-engine', data.PlayerTwo.engine || 'stockfish');
      setSelectValue('player2-elo', data.PlayerTwo.elo || 'Default');
      setSelectValue('player2-hb-mode', data.PlayerTwo.hand_brain_mode || 'normal');
    }
    
    // Update visibility based on player types
    updatePlayerTypeVisibility();
    
    // Game settings
    if (data.game) {
      setSelectValue('game-time-control', String(data.game.time_control || 0));
      document.getElementById('game-analysis-mode').checked = data.game.analysis_mode !== false;
      setSelectValue('game-analysis-engine', data.game.analysis_engine || 'stockfish');
    }
    
    // Display settings
    document.getElementById('display-show-board').checked = data.game?.show_board !== false;
    document.getElementById('display-show-clock').checked = data.game?.show_clock !== false;
    document.getElementById('display-show-analysis').checked = data.game?.show_analysis !== false;
    document.getElementById('display-show-graph').checked = data.game?.show_graph !== false;
    document.getElementById('display-led-brightness').value = data.game?.led_brightness || 5;
    document.getElementById('led-brightness-value').textContent = data.game?.led_brightness || 5;
    
    // Lichess
    if (data.lichess) {
      document.getElementById('lichess-api-token').value = data.lichess.api_token || '';
      document.getElementById('lichess-range').value = data.lichess.range || '';
    }
    
    // Sound
    if (data.sound) {
      document.getElementById('sound-enabled').checked = data.sound.sound === 'on';
      document.getElementById('sound-key-press').checked = data.sound.key_press === 'on';
      document.getElementById('sound-game-event').checked = data.sound.game_event === 'on';
      document.getElementById('sound-piece-event').checked = data.sound.piece_event === 'on';
      document.getElementById('sound-error').checked = data.sound.error === 'on';
    }
    
    // System
    if (data.system) {
      document.getElementById('system-developer').checked = data.system.developer === 'True' || data.system.developer === true;
    }
    
    // Database
    if (data.DATABASE) {
      document.getElementById('database-uri').value = data.DATABASE.database_uri || '';
    }
  }
  
  function setSelectValue(id, value) {
    const select = document.getElementById(id);
    if (select) {
      for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].value === value) {
          select.selectedIndex = i;
          return;
        }
      }
    }
  }
  
  function gatherSettings() {
    return {
      PlayerOne: {
        type: document.getElementById('player1-type').value,
        name: document.getElementById('player1-name').value,
        engine: document.getElementById('player1-engine').value,
        elo: document.getElementById('player1-elo').value,
        hand_brain_mode: document.getElementById('player1-hb-mode').value
      },
      PlayerTwo: {
        type: document.getElementById('player2-type').value,
        name: document.getElementById('player2-name').value,
        engine: document.getElementById('player2-engine').value,
        elo: document.getElementById('player2-elo').value,
        hand_brain_mode: document.getElementById('player2-hb-mode').value
      },
      game: {
        time_control: parseInt(document.getElementById('game-time-control').value),
        analysis_mode: document.getElementById('game-analysis-mode').checked,
        analysis_engine: document.getElementById('game-analysis-engine').value,
        show_board: document.getElementById('display-show-board').checked,
        show_clock: document.getElementById('display-show-clock').checked,
        show_analysis: document.getElementById('display-show-analysis').checked,
        show_graph: document.getElementById('display-show-graph').checked,
        led_brightness: parseInt(document.getElementById('display-led-brightness').value)
      },
      lichess: {
        api_token: document.getElementById('lichess-api-token').value,
        range: document.getElementById('lichess-range').value
      },
      sound: {
        sound: document.getElementById('sound-enabled').checked ? 'on' : 'off',
        key_press: document.getElementById('sound-key-press').checked ? 'on' : 'off',
        game_event: document.getElementById('sound-game-event').checked ? 'on' : 'off',
        piece_event: document.getElementById('sound-piece-event').checked ? 'on' : 'off',
        error: document.getElementById('sound-error').checked ? 'on' : 'off'
      },
      system: {
        developer: document.getElementById('system-developer').checked
      },
      DATABASE: {
        database_uri: document.getElementById('database-uri').value
      }
    };
  }
  
  function saveSettings() {
    const settings = gatherSettings();
    
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        hasChanges = false;
        document.getElementById('applySettingsBar').classList.remove('show');
        showNotification('Settings saved', 'success');
      } else {
        showNotification('Failed to save: ' + data.error, 'error');
      }
    })
    .catch(err => {
      showNotification('Error saving settings', 'error');
    });
  }
  
  function saveAndApply() {
    const settings = gatherSettings();
    
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Now apply to running system
        return fetch('/api/settings/apply', { method: 'POST' });
      } else {
        throw new Error(data.error);
      }
    })
    .then(response => response.json())
    .then(data => {
      hasChanges = false;
      document.getElementById('applySettingsBar').classList.remove('show');
      showNotification('Settings saved and applied', 'success');
    })
    .catch(err => {
      showNotification('Error: ' + err.message, 'error');
    });
  }
  
  function discardChanges() {
    applySettingsToForm(originalSettings);
    hasChanges = false;
    document.getElementById('applySettingsBar').classList.remove('show');
  }
  
  function switchToOriginalCentaur() {
    if (!confirm('Switch to the original Centaur software? Universal Chess will stop running.')) {
      return;
    }
    fetch('/return2dgtcentaurmods').then(() => {
      showNotification('Switching to original Centaur...', 'info');
    });
  }
  
  function showNotification(message, type) {
    // Simple notification - could be enhanced with toast library
    alert(message);
  }
  
  // Load engines list for dropdowns
  function loadEnginesForDropdowns() {
    fetch('/api/engines')
      .then(response => response.json())
      .then(engines => {
        const selects = ['player1-engine', 'player2-engine', 'game-analysis-engine'];
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '';
            engines.filter(e => e.installed).forEach(engine => {
              const option = document.createElement('option');
              option.value = engine.name;
              option.textContent = engine.display_name || engine.name;
              select.appendChild(option);
            });
          }
        });
      })
      .catch(err => console.error('Failed to load engines:', err));
  }
  
  // Load full engine list for management
  function loadEnginesList() {
    fetch('/api/engines/all')
      .then(response => response.json())
      .then(engines => {
        renderEnginesList(engines);
      })
      .catch(err => {
        console.error('Failed to load engines:', err);
        document.getElementById('engines-list').innerHTML = 
          '<div class="settings-card"><p class="has-text-danger">Failed to load engines</p></div>';
      });
  }
  
  function renderEnginesList(engines) {
    const container = document.getElementById('engines-list');
    let html = '';
    
    // Group engines by tier
    const tiers = {
      'top': { title: 'Top Tier Engines (3300+ ELO)', engines: [] },
      'strong': { title: 'Strong Engines (2900-3200 ELO)', engines: [] },
      'specialty': { title: 'Specialty & Personality Engines', engines: [] }
    };
    
    engines.forEach(engine => {
      if (engine.name === 'stockfish' || engine.name === 'berserk' || 
          engine.name === 'koivisto' || engine.name === 'ethereal') {
        tiers.top.engines.push(engine);
      } else if (engine.name === 'demolito' || engine.name === 'weiss' || 
                 engine.name === 'arasan' || engine.name === 'smallbrain') {
        tiers.strong.engines.push(engine);
      } else {
        tiers.specialty.engines.push(engine);
      }
    });
    
    for (const tier of Object.values(tiers)) {
      if (tier.engines.length === 0) continue;
      
      html += `<div class="settings-card"><div class="settings-group">`;
      html += `<h3 class="settings-group-title">${tier.title}</h3>`;
      
      tier.engines.forEach(engine => {
        const isSystem = engine.is_system_package;
        const isInstalled = engine.installed;
        const installTime = engine.estimated_install_minutes;
        
        let statusBadge = '';
        let actionButton = '';
        
        if (isSystem) {
          statusBadge = '<span class="tag is-success">System Package</span>';
          actionButton = '';
        } else if (isInstalled) {
          statusBadge = '<span class="tag is-success">Installed</span>';
          actionButton = `<button class="button is-small is-danger is-outlined" onclick="uninstallEngine('${engine.name}')">Uninstall</button>`;
        } else {
          statusBadge = '<span class="tag is-light">Not Installed</span>';
          const prebuiltNote = engine.has_prebuilt ? ' (pre-built available)' : '';
          actionButton = `<button class="button is-small is-primary" onclick="installEngine('${engine.name}')">Install${prebuiltNote}</button>`;
        }
        
        html += `
          <div class="engine-card" style="padding: 1rem 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                  <strong style="font-size: 1.1rem;">${engine.display_name}</strong>
                  ${statusBadge}
                </div>
                <div style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                  ${engine.summary}
                </div>
                <div style="color: var(--color-text-muted); font-size: 0.85rem;">
                  ${engine.description}
                </div>
                ${!isSystem && !isInstalled ? `<div style="color: var(--color-text-muted); font-size: 0.8rem; margin-top: 0.5rem;">Estimated install time: ~${installTime} minutes</div>` : ''}
              </div>
              <div style="flex-shrink: 0;">
                ${actionButton}
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
    }
    
    container.innerHTML = html;
  }
  
  function installEngine(engineName) {
    if (!confirm(`Install ${engineName}? This may take several minutes.`)) {
      return;
    }
    
    showQueueStatus();
    addToQueueDisplay(engineName, 'Installing...');
    
    fetch('/api/engines/install', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ engine: engineName })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(`${engineName} installation started`, 'info');
        pollInstallStatus();
      } else {
        updateQueueDisplay(engineName, 'failed', data.error);
        showNotification(`Failed to start install: ${data.error}`, 'error');
      }
    })
    .catch(err => {
      updateQueueDisplay(engineName, 'failed', err.message);
      showNotification('Error starting installation', 'error');
    });
  }
  
  function uninstallEngine(engineName) {
    if (!confirm(`Uninstall ${engineName}? This cannot be undone.`)) {
      return;
    }
    
    fetch('/api/engines/uninstall', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ engine: engineName })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(`${engineName} uninstalled`, 'success');
        loadEnginesList();
        loadEnginesForDropdowns();
      } else {
        showNotification(`Failed to uninstall: ${data.error}`, 'error');
      }
    })
    .catch(err => {
      showNotification('Error uninstalling engine', 'error');
    });
  }
  
  function showQueueStatus() {
    document.getElementById('engine-queue-status').style.display = 'block';
  }
  
  function hideQueueStatus() {
    document.getElementById('engine-queue-status').style.display = 'none';
  }
  
  function addToQueueDisplay(engineName, status) {
    const list = document.getElementById('engine-queue-list');
    list.innerHTML += `
      <div id="queue-item-${engineName}" class="engine-queue-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
        <span><strong>${engineName}</strong></span>
        <span class="queue-status has-text-info">${status}</span>
      </div>
    `;
  }
  
  function updateQueueDisplay(engineName, status, message) {
    const item = document.getElementById(`queue-item-${engineName}`);
    if (!item) return;
    
    const statusEl = item.querySelector('.queue-status');
    if (status === 'completed') {
      statusEl.className = 'queue-status has-text-success';
      statusEl.textContent = 'Completed';
    } else if (status === 'failed') {
      statusEl.className = 'queue-status has-text-danger';
      statusEl.textContent = message || 'Failed';
    } else {
      statusEl.textContent = message || status;
    }
  }
  
  let pollInterval = null;
  
  function pollInstallStatus() {
    if (pollInterval) return;
    
    pollInterval = setInterval(() => {
      fetch('/api/engines/status')
        .then(response => response.json())
        .then(data => {
          if (data.installing) {
            updateQueueDisplay(data.engine, 'installing', data.progress);
          } else {
            // Installation finished
            clearInterval(pollInterval);
            pollInterval = null;
            
            if (data.last_result) {
              if (data.last_result.success) {
                updateQueueDisplay(data.last_result.engine, 'completed');
                showNotification(`${data.last_result.engine} installed successfully`, 'success');
              } else {
                updateQueueDisplay(data.last_result.engine, 'failed', data.last_result.error);
              }
            }
            
            loadEnginesList();
            loadEnginesForDropdowns();
            
            // Hide queue after a delay
            setTimeout(hideQueueStatus, 3000);
          }
        })
        .catch(err => {
          console.error('Failed to poll status:', err);
        });
    }, 2000);
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadEnginesForDropdowns();
    loadEnginesList();
    loadSettings();
  });
</script>

{% endblock %}
