{# Shared chessboard component for consistent board display across pages #}
{# Usage: {% include 'chessboard_component.html' %} #}
{# Optional variables: fen, board_id (default: 'board1'), board_width (default: 600) #}

{% set board_id = board_id|default('board1') %}
{% set board_width = board_width|default(600) %}

<div id="chessboard-container">
    <style>
        #{{ board_id }} {
            width: 100%;
            max-width: {{ board_width }}px;
        }
        /* Original gray tones matching DGT board */
        .white-1e1d7 { background-color: #e5e5e5; color: #131313 }
        .black-3c85d { background-color: #b2b2b2; color: #131313 }
    </style>
    <div id="{{ board_id }}"></div>
</div>

<script src="{{ url_for('static', filename='js/jquery-3.4.1.min.js') }}"></script>
<script src="{{ url_for('static', filename='chessboardjs/js/chessboard-1.0.0.min.js') }}"></script>
<script>
(function() {
    var fen = '{{ fen|default("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR") }}';
    var config = {
        position: fen.split(' ')[0],
        pieceTheme: "{{ url_for('piece_svg', piece_code='wK') }}".replace("wK.svg", "{piece}.svg")
    };
    window.{{ board_id }} = Chessboard('{{ board_id }}', config);
    window.{{ board_id }}Fen = fen;

    function assignSquareIds(boardId) {
        var boardEl = document.getElementById(boardId);
        if (!boardEl) return;
        var squares = boardEl.querySelectorAll('div[class*="square-"]');
        for (var i = 0; i < squares.length; i++) {
            var el = squares[i];
            var classes = el.className.split(' ');
            for (var j = 0; j < classes.length; j++) {
                if (/^square-[a-h][1-8]$/.test(classes[j])) {
                    var coord = classes[j].substring(7);
                    el.id = boardId + '-square-' + coord;
                    break;
                }
            }
        }
    }

    assignSquareIds('{{ board_id }}');

    window.addEventListener('resize', function() {
        window.{{ board_id }}.resize();
        assignSquareIds('{{ board_id }}');
    });

    // Expose helper for other scripts
    window.assignSquareIds = assignSquareIds;
    window.normalizePlacementFen = function(fen) { return (fen || '').split(' ')[0]; };
    window.updateChessboardPosition = function(boardId, fen) {
        var board = window[boardId];
        if (board && typeof board.position === 'function') {
            board.position((fen || '').split(' ')[0]);
            assignSquareIds(boardId);
        }
    };
})();
</script>
